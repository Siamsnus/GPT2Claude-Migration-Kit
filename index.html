<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPT to Claude Migration Kit - Export everything from ChatGPT</title>
<meta name="description" content="Export your ChatGPT memories, conversations, and instructions. No install needed.">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #08080a; --surface: #111114; --surface2: #18181c; --border: #252530;
    --text: #e4e4ea; --text-dim: #7a7a88; --accent: #d4a574;
    --accent-glow: rgba(212, 165, 116, 0.15); --gpt: #9898d4;
    --green: #7eb8a0; --red: #d47474;
    --mono: 'Space Mono', monospace; --sans: 'DM Sans', system-ui, sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); line-height: 1.7; min-height: 100vh; overflow-x: hidden; }
  body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 1; }
  .container { max-width: 720px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 2; }
  .hero { padding: 6rem 0 4rem; text-align: center; }
  .hero-badge { display: inline-block; padding: 4px 14px; border: 1px solid var(--border); border-radius: 100px; font-family: var(--mono); font-size: 0.72rem; color: var(--text-dim); margin-bottom: 2rem; letter-spacing: 0.05em; }
  .hero h1 { font-size: clamp(2.2rem, 5vw, 3.2rem); font-weight: 700; letter-spacing: -0.03em; line-height: 1.15; margin-bottom: 1.5rem; }
  .hero h1 .gpt { color: var(--gpt); } .hero h1 .arrow { color: var(--text-dim); opacity: 0.4; } .hero h1 .claude { color: var(--accent); }
  .hero p { font-size: 1.1rem; color: var(--text-dim); max-width: 520px; margin: 0 auto 3rem; }

  .install-section { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 3rem 2.5rem; text-align: center; position: relative; overflow: hidden; }
  .install-section::before { content: ""; position: absolute; top: -1px; left: -1px; right: -1px; height: 3px; background: linear-gradient(90deg, var(--gpt), var(--accent)); border-radius: 20px 20px 0 0; }
  .install-section h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; }
  .install-section .subtitle { color: var(--text-dim); font-size: 0.92rem; margin-bottom: 2rem; }

  /* Tab system */
  .tab-bar { display: flex; justify-content: center; gap: 0; margin-bottom: 2rem; background: var(--bg); border-radius: 10px; padding: 4px; border: 1px solid var(--border); }
  .tab-btn { padding: 8px 20px; border: none; background: transparent; color: var(--text-dim); font-family: var(--sans); font-size: 0.85rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { background: var(--accent); color: var(--bg); }
  .tab-content { display: none; text-align: left; }
  .tab-content.active { display: block; }

  .bookmarklet-link { display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: linear-gradient(135deg, #d4a574, #c49060); color: #0a0a0b; font-family: var(--sans); font-size: 1rem; font-weight: 700; text-decoration: none; border-radius: 12px; cursor: grab; transition: all 0.2s ease; box-shadow: 0 4px 20px var(--accent-glow); user-select: none; }
  .bookmarklet-link:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
  .drag-hint { margin-top: 1rem; font-size: 0.82rem; color: var(--text-dim); text-align: center; }
  .drag-hint strong { color: var(--text); }

  .install-steps { text-align: left; }
  .install-step { display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1.25rem; }
  .install-step-num { flex-shrink: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: var(--accent-glow); color: var(--accent); font-family: var(--mono); font-size: 0.8rem; font-weight: 700; }
  .install-step p { font-size: 0.9rem; color: var(--text-dim); }
  .install-step p strong { color: var(--text); }

  .url-box { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; font-family: var(--mono); font-size: 0.7rem; color: var(--accent); word-break: break-all; max-height: 80px; overflow-y: auto; margin: 0.75rem 0; line-height: 1.4; cursor: pointer; transition: border-color 0.2s; }
  .url-box:hover { border-color: var(--accent); }

  .action-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--accent); color: var(--bg); border: none; border-radius: 10px; font-family: var(--sans); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .action-btn.secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .action-btn.secondary:hover { border-color: var(--accent); }

  .copy-confirm { font-size: 0.82rem; color: var(--green); margin-top: 0.5rem; display: none; }

  .browser-detect { font-size: 0.82rem; color: var(--green); margin-bottom: 1rem; font-family: var(--mono); }

  .steps { padding: 4rem 0; }
  .steps h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 2rem; text-align: center; }
  .step-list { display: flex; flex-direction: column; gap: 1rem; }
  .step-item { display: flex; gap: 1.25rem; align-items: flex-start; padding: 1.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; }
  .step-item:hover { border-color: #353540; }
  .step-num { flex-shrink: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-family: var(--mono); font-size: 0.85rem; font-weight: 700; }
  .step-num.s1 { background: rgba(152,152,212,0.12); color: var(--gpt); }
  .step-num.s2 { background: var(--accent-glow); color: var(--accent); }
  .step-num.s3 { background: rgba(126,184,160,0.12); color: var(--green); }
  .step-text h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem; }
  .step-text p { font-size: 0.88rem; color: var(--text-dim); }

  .exports-section { padding: 0 0 4rem; }
  .exports-section h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 2rem; text-align: center; }
  .export-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
  .export-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 1.5rem; text-align: center; }
  .export-card .icon { font-size: 2rem; margin-bottom: 0.75rem; }
  .export-card h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem; }
  .export-card p { font-size: 0.8rem; color: var(--text-dim); }
  .export-card .filename { display: inline-block; margin-top: 0.75rem; font-family: var(--mono); font-size: 0.7rem; padding: 3px 10px; background: var(--surface2); border-radius: 4px; color: var(--accent); }

  .fallback-box { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 2rem; margin-bottom: 1rem; }
  .fallback-box h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
  .fallback-box p { font-size: 0.88rem; color: var(--text-dim); margin-bottom: 0.5rem; }

  .faq { padding: 0 0 4rem; }
  .faq h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 2rem; text-align: center; }
  .faq-item { padding: 1.25rem 0; border-bottom: 1px solid var(--border); }
  .faq-item:first-child { border-top: 1px solid var(--border); }
  .faq-item h3 { font-size: 0.92rem; font-weight: 600; margin-bottom: 0.4rem; }
  .faq-item p { font-size: 0.88rem; color: var(--text-dim); }

  .footer { padding: 3rem 0; border-top: 1px solid var(--border); text-align: center; font-size: 0.8rem; color: var(--text-dim); }
  .footer a { color: var(--accent); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }
  .footer p { margin-bottom: 0.4rem; }

  @media (max-width: 640px) { .hero { padding: 4rem 0 3rem; } .install-section { padding: 2rem 1.5rem; } .export-grid { grid-template-columns: 1fr; } .container { padding: 0 1.25rem; } .tab-btn { padding: 6px 12px; font-size: 0.78rem; } }
</style>
</head>
<body>
<div class="container">

  <div class="hero">
    <div class="hero-badge">v2.3 — OPEN SOURCE — MIT LICENSE</div>
    <h1>Move from <span class="gpt">ChatGPT</span> <span class="arrow">→</span> <span class="claude">Claude</span></h1>
    <p>Export your memories, every conversation, and all custom instructions. No extensions to install. No data leaves your browser.</p>
  </div>

  <!-- ========== INSTALL SECTION ========== -->
  <div class="install-section" id="install">
    <h2>Add the export tool</h2>
    <p class="subtitle">Choose your browser, follow the steps. Takes 30 seconds.</p>

    <div id="browser-detect" class="browser-detect"></div>

    <div class="tab-bar">
      <button class="tab-btn active" onclick="showTab('chrome')">Chrome / Edge / Brave</button>
      <button class="tab-btn" onclick="showTab('firefox')">Firefox</button>
      <button class="tab-btn" onclick="showTab('paste')">Any browser</button>
    </div>

    <!-- CHROME TAB -->
    <div class="tab-content active" id="tab-chrome">
      <div style="text-align:center; margin-bottom:1.5rem;">
        <a class="bookmarklet-link" id="bookmarklet-btn" href="javascript:(function() {%0Aif (document.getElementById(%22gpt2claude-panel%22)) {%0Avar existing = document.getElementById(%22gpt2claude-panel%22);%0Aexisting.style.animation = %22g2c-shake 0.3s ease-in-out%22;%0AsetTimeout(function() { existing.style.animation = %22%22; }, 300);%0Areturn;%0A}%0Avar style = document.createElement(%22style%22);%0Astyle.textContent = %22%5C%0A@keyframes g2c-fadein { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }%5C%0A@keyframes g2c-shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }%5C%0A@keyframes g2c-spin { to { transform: rotate(360deg); } }%5C%0A@keyframes g2c-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }%5C%0A@keyframes g2c-indeterminate { 0% { left: -30%; width: 30%; } 50% { left: 50%; width: 30%; } 100% { left: 100%; width: 30%; } }%5C%0A@keyframes g2c-pulse-count { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }%5C%0A@keyframes g2c-dot-bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-4px); } }%5C%0A.g2c-progress-fill.indeterminate { position: relative; width: 100% !important; background: none !important; overflow: hidden; }%5C%0A.g2c-progress-fill.indeterminate::after { content: ''; position: absolute; top: 0; left: -30%; width: 30%; height: 100%; background: linear-gradient(90deg, transparent, #d4a574, transparent); border-radius: 3px; animation: g2c-indeterminate 1.5s ease-in-out infinite; }%5C%0A.g2c-scan-hero { text-align: center; padding: 20px 0 10px; }%5C%0A.g2c-scan-hero .g2c-scan-count { font-size: 42px; font-weight: 800; color: #d4a574; font-variant-numeric: tabular-nums; animation: g2c-pulse-count 2s ease-in-out infinite; line-height: 1; }%5C%0A.g2c-scan-hero .g2c-scan-label { font-size: 12px; color: #888; margin-top: 4px; }%5C%0A.g2c-scan-hero .g2c-scan-status { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 12px; font-size: 12px; color: #999; }%5C%0A.g2c-scan-dots { display: flex; gap: 3px; }%5C%0A.g2c-scan-dots span { width: 4px; height: 4px; background: #d4a574; border-radius: 50%; animation: g2c-dot-bounce 1.2s ease-in-out infinite; }%5C%0A.g2c-scan-dots span:nth-child(2) { animation-delay: 0.15s; }%5C%0A.g2c-scan-dots span:nth-child(3) { animation-delay: 0.3s; }%5C%0A.g2c-scan-models { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 14px; padding-top: 14px; border-top: 1px solid #2a2a35; }%5C%0A.g2c-scan-tag { font-size: 10px; padding: 3px 10px; background: #1e1e26; border: 1px solid #2a2a35; border-radius: 20px; color: #a0a0e0; font-family: 'SF Mono', Consolas, monospace; }%5C%0A.g2c-scan-reassure { font-size: 11px; color: #555; text-align: center; margin-top: 12px; }%5C%0A.g2c-dl-hero { text-align: center; padding: 16px 0 8px; }%5C%0A.g2c-dl-hero .g2c-dl-count { font-size: 28px; font-weight: 700; color: #7eb8a0; }%5C%0A.g2c-dl-hero .g2c-dl-of { font-size: 14px; color: #555; }%5C%0A.g2c-dl-hero .g2c-dl-title { font-size: 11px; color: #888; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px; }%5C%0A.g2c-dl-pct { font-size: 11px; color: #d4a574; font-family: 'SF Mono', Consolas, monospace; text-align: right; margin-top: 6px; }%5C%0A.g2c-dl-remaining { font-size: 11px; color: #666; text-align: center; margin-top: 8px; }%5C%0A.g2c-complete { text-align: center; padding: 20px 0 10px; }%5C%0A.g2c-complete-icon { font-size: 36px; margin-bottom: 6px; }%5C%0A.g2c-complete-title { font-size: 18px; font-weight: 700; color: #7eb8a0; }%5C%0A.g2c-complete-sub { font-size: 12px; color: #888; margin-top: 6px; }%5C%0A.g2c-complete-models { font-size: 11px; color: #d4a574; margin-top: 6px; font-family: 'SF Mono', Consolas, monospace; }%5C%0A.g2c-complete-models-wrap { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 12px; }%5C%0A.g2c-models-extra { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; width: 100%; margin-top: 4px; }%5C%0A.g2c-models-toggle { font-size: 10px; padding: 3px 10px; background: none; border: 1px dashed #333340; border-radius: 20px; color: #888; cursor: pointer; font-family: 'SF Mono', Consolas, monospace; }%5C%0A.g2c-models-toggle:hover { border-color: #d4a574; color: #d4a574; }%5C%0A.g2c-whatsnext { margin: 16px 0; padding: 14px; background: #141418; border: 1px solid #252530; border-radius: 10px; }%5C%0A.g2c-whatsnext-title { font-size: 11px; color: #888; margin-bottom: 10px; font-weight: 600; }%5C%0A.g2c-whatsnext-item { font-size: 12px; color: #ccc; line-height: 1.8; margin-bottom: 10px; }%5C%0A.g2c-whatsnext-item:last-child { margin-bottom: 0; }%5C%0A.g2c-whatsnext-item a { color: #d4a574; text-decoration: none; }%5C%0A.g2c-whatsnext-item a:hover { text-decoration: underline; }%5C%0A.g2c-whatsnext-badge { font-size: 10px; color: #7eb8a0; background: rgba(126,184,160,0.12); padding: 1px 6px; border-radius: 4px; }%5C%0A.g2c-copy-log { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; padding: 6px 0; margin-top: 10px; margin-left: 12px; }%5C%0A.g2c-copy-log:hover { color: #aaa; }%5C%0A#gpt2claude-panel { position: fixed; top: 50%; right: 24px; transform: translateY(-50%); width: 360px; background: #1a1a1f; border: 1px solid #333340; border-radius: 16px; box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.06); z-index: 999999; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #e8e8ec; animation: g2c-fadein 0.3s ease-out; }%5C%0A#gpt2claude-panel * { box-sizing: border-box; margin: 0; padding: 0; }%5C%0A.g2c-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 22px 14px; border-bottom: 1px solid #2a2a35; background: #1e1e24; border-radius: 16px 16px 0 0; }%5C%0A.g2c-title { font-size: 15px; font-weight: 700; letter-spacing: -0.01em; }%5C%0A.g2c-title span.gpt { color: #a0a0e0; }%5C%0A.g2c-title span.arrow { color: #555; margin: 0 4px; }%5C%0A.g2c-title span.claude { color: #d4a574; }%5C%0A.g2c-version { font-size: 10px; color: #666; font-weight: 600; margin-top: 2px; }%5C%0A.g2c-close { background: none; border: none; color: #777; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; line-height: 1; }%5C%0A.g2c-close:hover { background: #252530; color: #e8e8ec; }%5C%0A.g2c-body { padding: 18px 22px 14px; }%5C%0A.g2c-btn { width: 100%; padding: 14px 16px; border: 1px solid #333340; border-radius: 12px; background: #222228; color: #e8e8ec; font-size: 13px; font-weight: 600; cursor: pointer; text-align: left; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; transition: all 0.15s ease; position: relative; overflow: hidden; }%5C%0A.g2c-btn:hover { background: #2a2a32; border-color: #444450; transform: translateY(-1px); }%5C%0A.g2c-btn:active { transform: translateY(0); }%5C%0A.g2c-btn.running { pointer-events: none; border-color: #d4a574; }%5C%0A.g2c-btn.done { border-color: #7eb8a0; }%5C%0A.g2c-btn.error { border-color: #e07070; }%5C%0A.g2c-btn-icon { font-size: 20px; width: 28px; text-align: center; flex-shrink: 0; }%5C%0A.g2c-btn-text { flex: 1; }%5C%0A.g2c-btn-sub { font-size: 11px; color: #777; font-weight: 400; margin-top: 3px; }%5C%0A.g2c-progress { margin-top: 10px; }%5C%0A.g2c-progress-bar { width: 100%; height: 5px; background: #252530; border-radius: 3px; overflow: hidden; }%5C%0A.g2c-progress-fill { height: 100%; background: linear-gradient(90deg, #d4a574, #e8c49a); border-radius: 3px; transition: width 0.3s ease; width: 0%; }%5C%0A.g2c-progress-text { font-size: 11px; color: #999; margin-top: 6px; }%5C%0A.g2c-log { margin-top: 14px; max-height: 140px; overflow-y: auto; background: #141418; border: 1px solid #252530; border-radius: 10px; padding: 10px 12px; font-family: 'SF Mono', 'Consolas', monospace; font-size: 11px; line-height: 1.6; color: #999; display: none; }%5C%0A.g2c-log.visible { display: block; }%5C%0A.g2c-log-entry { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }%5C%0A.g2c-log-entry.error { color: #e07070; }%5C%0A.g2c-log-entry.success { color: #7eb8a0; }%5C%0A.g2c-footer { padding: 14px 22px; border-top: 1px solid #252530; display: flex; justify-content: space-between; align-items: center; }%5C%0A.g2c-footer-text { font-size: 10px; color: #555; }%5C%0A.g2c-footer-link { font-size: 10px; color: #d4a574; text-decoration: none; }%5C%0A.g2c-footer-link:hover { text-decoration: underline; }%5C%0A.g2c-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #444; border-top-color: #d4a574; border-radius: 50%; animation: g2c-spin 0.6s linear infinite; }%5C%0A.g2c-toggle-log { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; padding: 6px 0; margin-top: 10px; }%5C%0A.g2c-toggle-log:hover { color: #aaa; }%5C%0A.g2c-drag-handle { cursor: move; }%5C%0A.g2c-divider { height: 1px; background: #2a2a35; margin: 6px 0 10px; }%5C%0A.g2c-filter-panel { margin-top: 10px; }%5C%0A.g2c-filter-section { margin-bottom: 12px; }%5C%0A.g2c-filter-label { font-size: 10px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }%5C%0A.g2c-filter-models { max-height: 120px; overflow-y: auto; background: #141418; border: 1px solid #252530; border-radius: 8px; padding: 6px 8px; }%5C%0A.g2c-model-row { display: flex; align-items: center; padding: 3px 0; font-size: 12px; cursor: pointer; color: #ccc; }%5C%0A.g2c-model-row:hover { color: #fff; }%5C%0A.g2c-model-row input { margin-right: 8px; accent-color: #d4a574; }%5C%0A.g2c-model-row .cnt { color: #666; margin-left: auto; font-size: 10px; font-family: monospace; }%5C%0A.g2c-filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }%5C%0A.g2c-filter-input { flex: 1; padding: 6px 8px; background: #141418; border: 1px solid #252530; border-radius: 6px; color: #e8e8ec; font-size: 12px; font-family: monospace; outline: none; }%5C%0A.g2c-filter-input:focus { border-color: #d4a574; }%5C%0A.g2c-filter-input::placeholder { color: #555; }%5C%0A.g2c-filter-summary { font-size: 12px; color: #d4a574; padding: 8px 0; font-weight: 600; }%5C%0A.g2c-filter-drop { border: 1px dashed #333340; border-radius: 8px; padding: 10px; text-align: center; font-size: 11px; color: #666; cursor: pointer; transition: all 0.15s; }%5C%0A.g2c-filter-drop:hover { border-color: #d4a574; color: #999; }%5C%0A.g2c-filter-drop.active { border-color: #7eb8a0; color: #7eb8a0; }%5C%0A.g2c-select-btns { display: flex; gap: 6px; margin-top: 4px; }%5C%0A.g2c-select-btns button { background: none; border: none; color: #666; font-size: 10px; cursor: pointer; padding: 0; }%5C%0A.g2c-select-btns button:hover { color: #d4a574; }%5C%0A%22;%0Adocument.head.appendChild(style);%0Avar panel = document.createElement(%22div%22);%0Apanel.id = %22gpt2claude-panel%22;%0Apanel.innerHTML = '%5C%0A<div class=%22g2c-header g2c-drag-handle%22>%5C%0A<div>%5C%0A<div class=%22g2c-title%22><span class=%22gpt%22>GPT</span><span class=%22arrow%22>%5Cu2192</span><span class=%22claude%22>Claude</span></div>%5C%0A<div class=%22g2c-version%22>Migration Kit v2.3</div>%5C%0A</div>%5C%0A<button class=%22g2c-close%22 id=%22g2c-close%22>%5Cu00D7</button>%5C%0A</div>%5C%0A<div class=%22g2c-body%22>%5C%0A<button class=%22g2c-btn%22 id=%22g2c-btn-memory%22>%5C%0A<div class=%22g2c-btn-icon%22>%5CuD83E%5CuDDE0</div>%5C%0A<div class=%22g2c-btn-text%22>%5C%0AExport Memories%5C%0A<div class=%22g2c-btn-sub%22>Facts ChatGPT learned about you</div>%5C%0A</div>%5C%0A</button>%5C%0A<button class=%22g2c-btn%22 id=%22g2c-btn-convos%22>%5C%0A<div class=%22g2c-btn-icon%22>%5CuD83D%5CuDCAC</div>%5C%0A<div class=%22g2c-btn-text%22>%5C%0AExport All Conversations%5C%0A<div class=%22g2c-btn-sub%22>Scans first, then you choose what to download</div>%5C%0A</div>%5C%0A</button>%5C%0A<button class=%22g2c-btn%22 id=%22g2c-btn-instructions%22>%5C%0A<div class=%22g2c-btn-icon%22>%5Cu2699%5CuFE0F</div>%5C%0A<div class=%22g2c-btn-text%22>%5C%0AExport Instructions%5C%0A<div class=%22g2c-btn-sub%22>Custom instructions &amp; settings</div>%5C%0A</div>%5C%0A</button>%5C%0A<button class=%22g2c-btn%22 id=%22g2c-btn-all%22 style=%22border-color:#d4a574;background:#222228;%22>%5C%0A<div class=%22g2c-btn-icon%22>%5CuD83D%5CuDCE5</div>%5C%0A<div class=%22g2c-btn-text%22>%5C%0A<span style=%22color:#d4a574;%22>Export Everything</span>%5C%0A<div class=%22g2c-btn-sub%22>All three in one click</div>%5C%0A</div>%5C%0A</button>%5C%0A<div class=%22g2c-progress%22 id=%22g2c-progress%22 style=%22display:none;%22>%5C%0A<div class=%22g2c-progress-bar%22><div class=%22g2c-progress-fill%22 id=%22g2c-progress-fill%22></div></div>%5C%0A<div class=%22g2c-progress-text%22 id=%22g2c-progress-text%22></div>%5C%0A</div>%5C%0A<button class=%22g2c-toggle-log%22 id=%22g2c-toggle-log%22>Show log %5Cu25BC</button>%5C%0A<button class=%22g2c-copy-log%22 id=%22g2c-copy-log%22>Copy log</button>%5C%0A<div class=%22g2c-log%22 id=%22g2c-log%22></div>%5C%0A</div>%5C%0A<div class=%22g2c-footer%22>%5C%0A<span class=%22g2c-footer-text%22>All data stays in your browser</span>%5C%0A<a class=%22g2c-footer-link%22 href=%22https://github.com/Siamsnus/GPT2Claude-Migration-Kit%22 target=%22_blank%22>GitHub</a>%5C%0A</div>%5C%0A';%0Adocument.body.appendChild(panel);%0Avar isDragging = false;%0Avar dragOffsetX = 0;%0Avar dragOffsetY = 0;%0Avar header = panel.querySelector(%22.g2c-drag-handle%22);%0Aheader.addEventListener(%22mousedown%22, function(e) {%0Aif (e.target.classList.contains(%22g2c-close%22)) return;%0AisDragging = true;%0Avar rect = panel.getBoundingClientRect();%0AdragOffsetX = e.clientX - rect.left;%0AdragOffsetY = e.clientY - rect.top;%0Apanel.style.transition = %22none%22;%0Ae.preventDefault();%0A});%0Adocument.addEventListener(%22mousemove%22, function(e) {%0Aif (!isDragging) return;%0Apanel.style.right = %22auto%22;%0Apanel.style.transform = %22none%22;%0Apanel.style.left = (e.clientX - dragOffsetX) + %22px%22;%0Apanel.style.top = (e.clientY - dragOffsetY) + %22px%22;%0A});%0Adocument.addEventListener(%22mouseup%22, function() {%0AisDragging = false;%0Apanel.style.transition = %22%22;%0A});%0Avar logEl = document.getElementById(%22g2c-log%22);%0Avar progressEl = document.getElementById(%22g2c-progress%22);%0Avar progressFill = document.getElementById(%22g2c-progress-fill%22);%0Avar progressText = document.getElementById(%22g2c-progress-text%22);%0Afunction log(msg, type) {%0Avar entry = document.createElement(%22div%22);%0Aentry.className = %22g2c-log-entry%22 + (type ? %22 %22 + type : %22%22);%0Aentry.textContent = msg;%0AlogEl.appendChild(entry);%0AlogEl.scrollTop = logEl.scrollHeight;%0A}%0Afunction setProgress(pct, text) {%0AprogressEl.style.display = %22block%22;%0AprogressFill.style.width = pct + %22%%22;%0Aif (text) progressText.textContent = text;%0A}%0Afunction setButtonState(btn, state, label) {%0Abtn.className = %22g2c-btn %22 + state;%0Avar iconEl = btn.querySelector(%22.g2c-btn-icon%22);%0Aif (state === %22running%22) {%0AiconEl.innerHTML = '<div class=%22g2c-spinner%22></div>';%0A} else if (state === %22done%22) {%0AiconEl.textContent = %22%5Cu2705%22;%0A} else if (state === %22error%22) {%0AiconEl.textContent = %22%5Cu274C%22;%0A}%0Aif (label) {%0Abtn.querySelector(%22.g2c-btn-sub%22).textContent = label;%0A}%0A}%0Afunction downloadFile(content, filename, type) {%0Avar blob = new Blob([content], {type: type || %22text/plain%22});%0Avar url = URL.createObjectURL(blob);%0Avar a = document.createElement(%22a%22);%0Aa.href = url;%0Aa.download = filename;%0Adocument.body.appendChild(a);%0Aa.click();%0Adocument.body.removeChild(a);%0AURL.revokeObjectURL(url);%0Alog(%22Downloaded: %22 + filename, %22success%22);%0A}%0Afunction safeAddEvent(id, event, handler) {%0Avar el = document.getElementById(id);%0Aif (el) {%0Ael.addEventListener(event, handler);%0A} else {%0Alog(%22Warning: element #%22 + id + %22 not found%22, %22error%22);%0A}%0Areturn el;%0A}%0Avar cachedToken = null;%0Aasync function getToken() {%0Aif (cachedToken) return cachedToken;%0Alog(%22Authenticating...%22);%0Avar resp = await fetch(%22https://chatgpt.com/api/auth/session%22, {credentials: %22include%22});%0Aif (resp.status !== 200) {%0Athrow new Error(%22Auth failed (HTTP %22 + resp.status + %22). Are you logged in?%22);%0A}%0Avar data = await resp.json();%0Aif (!data.accessToken) {%0Athrow new Error(%22No token found. Please refresh chatgpt.com and try again.%22);%0A}%0AcachedToken = data.accessToken;%0Alog(%22Authenticated OK%22);%0Areturn cachedToken;%0A}%0Afunction getConvoModel(c) {%0Areturn c.default_model_slug || c.model || c.model_slug || c.gpt_model || %22unknown%22;%0A}%0Afunction getConvoTime(c) {%0Avar raw = c.update_time || c.updated_at || c.create_time || c.created_at || 0;%0Aif (!raw) return 0;%0Aif (typeof raw === %22string%22) {%0Avar parsed = new Date(raw).getTime() / 1000;%0Areturn isNaN(parsed) ? 0 : parsed;%0A}%0Aif (raw > 1e12) return raw / 1000;%0Areturn raw;%0A}%0Aasync function exportMemories() {%0Avar btn = document.getElementById(%22g2c-btn-memory%22);%0AsetButtonState(btn, %22running%22, %22Exporting...%22);%0Atry {%0Avar token = await getToken();%0Alog(%22Fetching memories...%22);%0Avar resp = await fetch(%22https://chatgpt.com/backend-api/memories%22, {%0Acredentials: %22include%22,%0Aheaders: {%22Authorization%22: %22Bearer %22 + token}%0A});%0Aif (resp.status !== 200) {%0Athrow new Error(%22Could not fetch memories (HTTP %22 + resp.status + %22)%22);%0A}%0Avar data = await resp.json();%0Avar memories = data.memories || data.results || data;%0Avar md = %22# ChatGPT Memory Export%5Cn%22;%0Amd += %22# Exported: %22 + new Date().toISOString() + %22%5Cn%22;%0Amd += %22# Tool: GPT2Claude Migration Kit v2.3%5Cn%5Cn%22;%0Avar count = 0;%0Aif (Array.isArray(memories)) {%0Acount = memories.length;%0Afor (var i = 0; i < memories.length; i++) {%0Avar m = memories[i];%0Avar content = m.content || m.value || m.text || m.memory || JSON.stringify(m);%0Amd += (i + 1) + %22. %22 + content + %22%5Cn%22;%0A}%0A} else {%0Amd += JSON.stringify(memories, null, 2);%0A}%0Alog(%22Found %22 + count + %22 memories%22);%0AdownloadFile(md, %22chatgpt_memories.md%22, %22text/markdown%22);%0AsetButtonState(btn, %22done%22, count + %22 memories exported%22);%0A} catch (err) {%0Alog(%22Memory export failed: %22 + err.message, %22error%22);%0AsetButtonState(btn, %22error%22, err.message);%0A}%0A}%0Avar scannedConvos = [];%0Avar previousExportIds = {};%0Avar BATCH_SIZE = 10;%0Aasync function exportConversations() {%0Avar btn = document.getElementById(%22g2c-btn-convos%22);%0AsetButtonState(btn, %22running%22, %22Scanning...%22);%0Avar progressEl = document.getElementById(%22g2c-progress%22);%0AprogressEl.style.display = %22block%22;%0Avar fillEl = document.getElementById(%22g2c-progress-fill%22);%0AfillEl.classList.add(%22indeterminate%22);%0AfillEl.style.width = %22100%%22;%0Avar scanHero = document.createElement(%22div%22);%0AscanHero.className = %22g2c-scan-hero%22;%0AscanHero.id = %22g2c-scan-hero%22;%0AscanHero.innerHTML = '<div class=%22g2c-scan-count%22 id=%22g2c-scan-count%22>0</div>' +%0A'<div class=%22g2c-scan-label%22>conversations found</div>' +%0A'<div class=%22g2c-scan-status%22 id=%22g2c-scan-status%22>' +%0A'<span class=%22g2c-scan-dots%22><span></span><span></span><span></span></span>' +%0A' Scanning your conversations%5Cu2026' +%0A'</div>' +%0A'<div class=%22g2c-scan-models%22 id=%22g2c-scan-models%22></div>' +%0A'<div class=%22g2c-scan-reassure%22>Filter options appear when scan completes</div>';%0AprogressEl.parentNode.insertBefore(scanHero, progressEl.nextSibling);%0Atry {%0Avar token = await getToken();%0Avar headers = {%22Authorization%22: %22Bearer %22 + token};%0AscannedConvos = [];%0Avar offset = 0;%0Avar liveModels = {};%0Avar scanLimit = 100;%0Alog(%22Scanning conversation list...%22);%0Awhile (true) {%0Avar listResp = await fetch(%0A%22https://chatgpt.com/backend-api/conversations?offset=%22 + offset + %22&limit=%22 + scanLimit + %22&order=updated%22,%0A{credentials: %22include%22, headers: headers}%0A);%0Aif (listResp.status !== 200) {%0Athrow new Error(%22Could not get conversations (HTTP %22 + listResp.status + %22)%22);%0A}%0Avar listData = await listResp.json();%0Avar items = listData.items || [];%0Alog(%22Batch: %22 + items.length + %22 conversations (offset %22 + offset + %22)%22);%0Aif (offset === 0 && items.length > 0) {%0Avar sampleKeys = Object.keys(items[0]).join(%22, %22);%0Alog(%22API fields: %22 + sampleKeys);%0Avar sample = items[0];%0Alog(%22Sample model: %22 + (sample.default_model_slug || sample.model || sample.model_slug || %22null%22));%0Alog(%22Sample time: update=%22 + sample.update_time + %22 create=%22 + sample.create_time);%0Alog(%22Sample gizmo: %22 + (sample.gizmo_id || sample.conversation_template_id || sample.workspace_id || %22none%22));%0A}%0Afor (var j = 0; j < items.length; j++) {%0AscannedConvos.push(items[j]);%0Avar m = getConvoModel(items[j]);%0AliveModels[m] = (liveModels[m] || 0) + 1;%0A}%0Avar countEl = document.getElementById(%22g2c-scan-count%22);%0Avar statusEl = document.getElementById(%22g2c-scan-status%22);%0Aif (countEl) countEl.textContent = scannedConvos.length.toLocaleString();%0Aif (statusEl) {%0AstatusEl.innerHTML = items.length >= scanLimit%0A? '<span class=%22g2c-scan-dots%22><span></span><span></span><span></span></span> Still scanning %5Cu2014 this takes a minute, all good'%0A: 'Scan complete!';%0A}%0Avar tagsHtml = %22%22;%0Avar modelKeys = Object.keys(liveModels).sort(function(a, b) { return liveModels[b] - liveModels[a]; });%0Afor (var mi = 0; mi < modelKeys.length; mi++) {%0AtagsHtml += '<span class=%22g2c-scan-tag%22>' + modelKeys[mi] + ' (' + liveModels[modelKeys[mi]] + ')</span>';%0A}%0Avar modelsEl = document.getElementById(%22g2c-scan-models%22);%0Aif (modelsEl) modelsEl.innerHTML = tagsHtml;%0Aoffset += items.length;%0Aif (items.length < scanLimit) break;%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A}%0Alog(%22Total conversations: %22 + scannedConvos.length);%0Atry {%0Alog(%22Checking for projects...%22);%0Avar statusEl = document.getElementById(%22g2c-scan-status%22);%0Aif (statusEl) statusEl.innerHTML = '<span class=%22g2c-scan-dots%22><span></span><span></span><span></span></span> Checking projects%5Cu2026';%0Avar discoveredProjects = {};%0Afor (var gi = 0; gi < scannedConvos.length; gi++) {%0Avar gid = scannedConvos[gi].gizmo_id || scannedConvos[gi].conversation_template_id || scannedConvos[gi].workspace_id || null;%0Aif (gid && gid.indexOf(%22g-p-%22) === 0 && !discoveredProjects[gid]) {%0AdiscoveredProjects[gid] = null; // name unknown yet%0Alog(%22Found project gizmo in conversation list: %22 + gid);%0A}%0A}%0Atry {%0Avar gizmoResp = await fetch(%0A%22https://chatgpt.com/backend-api/gizmos/discovery/mine%22,%0A{credentials: %22include%22, headers: headers}%0A);%0Aif (gizmoResp.status === 200) {%0Avar gizmoData = await gizmoResp.json();%0Avar gizmoItems = gizmoData.list || gizmoData.items || gizmoData.gizmos || [];%0Aif (Array.isArray(gizmoItems)) {%0Afor (var gmi = 0; gmi < gizmoItems.length; gmi++) {%0Avar gizmo = gizmoItems[gmi].resource || gizmoItems[gmi].gizmo || gizmoItems[gmi];%0Avar gizmoId = gizmo.id || gizmo.short_url || %22%22;%0Aif (gizmoId.indexOf(%22g-p-%22) === 0 || (gizmo.type && gizmo.type === %22project%22)) {%0Avar gName = (gizmo.display && gizmo.display.name) || gizmo.name || gizmo.title || %22Project%22;%0AdiscoveredProjects[gizmoId] = gName;%0Alog(%22Found project via API: %22 + gName + %22 (%22 + gizmoId + %22)%22);%0A}%0A}%0A}%0A} else {%0Alog(%22Gizmos API: HTTP %22 + gizmoResp.status + %22 (trying other methods)%22);%0A}%0A} catch (apiErr) {%0Alog(%22Gizmos API failed: %22 + apiErr.message + %22 (trying other methods)%22);%0A}%0Avar projLinks = document.querySelectorAll('a[href*=%22/g/g-p-%22]');%0Afor (var pl = 0; pl < projLinks.length; pl++) {%0Avar href = projLinks[pl].getAttribute(%22href%22) || %22%22;%0Avar idMatch = href.match(/g-p-[a-f0-9]+/);%0Aif (!idMatch) continue;%0Avar projId = idMatch[0];%0Aif (discoveredProjects[projId]) continue;%0Avar slugMatch = href.match(/g-p-[a-f0-9]+-([^/]+)/);%0Avar linkText = projLinks[pl].textContent.trim();%0Avar projName = linkText || (slugMatch ? slugMatch[1].replace(/-/g, %22 %22) : %22Project%22);%0Aif (href.indexOf(%22/c/%22) > -1) continue;%0AdiscoveredProjects[projId] = projName;%0Alog(%22Found project via DOM: %22 + projName + %22 (%22 + projId + %22)%22);%0A}%0Avar projIds = Object.keys(discoveredProjects);%0Aif (projIds.length > 0) {%0Alog(%22Found %22 + projIds.length + %22 project(s) total%22);%0Avar existingIdx = {};%0Afor (var ei = 0; ei < scannedConvos.length; ei++) {%0AexistingIdx[scannedConvos[ei].id] = ei;%0A}%0Afor (var pi = 0; pi < projIds.length; pi++) {%0Avar projId = projIds[pi];%0Avar projName = discoveredProjects[projId] || %22Project%22;%0Aif (projName === %22Project%22 || projName === null) {%0Atry {%0Avar infoResp = await fetch(%0A%22https://chatgpt.com/backend-api/gizmos/%22 + projId,%0A{credentials: %22include%22, headers: headers}%0A);%0Aif (infoResp.status === 200) {%0Avar infoData = await infoResp.json();%0Avar gizmoInfo = infoData.gizmo || infoData;%0AprojName = (gizmoInfo.display && gizmoInfo.display.name) || gizmoInfo.name || gizmoInfo.title || %22Project%22;%0Alog(%22Resolved project name: %22 + projName);%0A}%0A} catch (nameErr) {%0A}%0A}%0Alog(%22Fetching project: %22 + projName + %22 (%22 + projId + %22)%22);%0Avar statusEl = document.getElementById(%22g2c-scan-status%22);%0Aif (statusEl) statusEl.innerHTML = '<span class=%22g2c-scan-dots%22><span></span><span></span><span></span></span> Scanning project: ' + projName + '%5Cu2026';%0Avar cursor = 0;%0Avar projConvoCount = 0;%0Avar projTaggedCount = 0;%0Awhile (true) {%0Avar projConvoResp = await fetch(%0A%22https://chatgpt.com/backend-api/gizmos/%22 + projId + %22/conversations?cursor=%22 + cursor,%0A{credentials: %22include%22, headers: headers}%0A);%0Aif (projConvoResp.status !== 200) {%0Alog(%22Project %22 + projName + %22: HTTP %22 + projConvoResp.status, %22error%22);%0Abreak;%0A}%0Avar projConvoData = await projConvoResp.json();%0Avar projItems = projConvoData.items || [];%0Afor (var pj = 0; pj < projItems.length; pj++) {%0AprojItems[pj]._project = projName;%0AprojItems[pj]._project_id = projId;%0Aif (existingIdx[projItems[pj].id] === undefined) {%0AscannedConvos.push(projItems[pj]);%0AexistingIdx[projItems[pj].id] = scannedConvos.length - 1;%0AprojConvoCount++;%0A} else {%0Avar dupIdx = existingIdx[projItems[pj].id];%0AscannedConvos[dupIdx]._project = projName;%0AscannedConvos[dupIdx]._project_id = projId;%0AprojTaggedCount++;%0A}%0A}%0Avar countEl = document.getElementById(%22g2c-scan-count%22);%0Aif (countEl) countEl.textContent = scannedConvos.length.toLocaleString();%0Aif (projConvoData.cursor === null || projConvoData.cursor === undefined || projItems.length === 0) break;%0Acursor = projConvoData.cursor;%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A}%0Alog(%22Project %22 + projName + %22: %22 + projConvoCount + %22 new, %22 + projTaggedCount + %22 tagged%22);%0A}%0Alog(%22Total with projects: %22 + scannedConvos.length);%0A} else {%0Alog(%22No projects found%22);%0A}%0A} catch (projErr) {%0Alog(%22Projects check failed: %22 + projErr.message + %22 (continuing without)%22);%0A}%0AsetButtonState(btn, %22done%22, scannedConvos.length + %22 conversations found%22);%0Avar scanHeroEl = document.getElementById(%22g2c-scan-hero%22);%0Aif (scanHeroEl) scanHeroEl.parentNode.removeChild(scanHeroEl);%0Avar fillEl = document.getElementById(%22g2c-progress-fill%22);%0AfillEl.classList.remove(%22indeterminate%22);%0AfillEl.style.width = %220%%22;%0Adocument.getElementById(%22g2c-progress%22).style.display = %22none%22;%0AshowFilterPanel();%0A} catch (err) {%0Alog(%22Scan failed: %22 + err.message, %22error%22);%0AsetButtonState(btn, %22error%22, err.message);%0A}%0A}%0Afunction showFilterPanel() {%0Avar models = {};%0Avar oldest = Infinity;%0Avar newest = 0;%0Avar sources = {}; // Track main vs project conversations%0Afor (var i = 0; i < scannedConvos.length; i++) {%0Avar c = scannedConvos[i];%0Avar m = getConvoModel(c);%0Amodels[m] = (models[m] || 0) + 1;%0Avar t = getConvoTime(c);%0Aif (t > 0 && t < oldest) oldest = t;%0Aif (t > 0 && t > newest) newest = t;%0Avar src = c._project || %22Main conversations%22;%0Asources[src] = (sources[src] || 0) + 1;%0A}%0Avar modelKeys = Object.keys(models).sort(function(a, b) { return models[b] - models[a]; });%0Afunction tsToDate(ts) {%0Aif (!ts || ts === Infinity) return %22%22;%0Aif (typeof ts === %22string%22) {%0Avar d = new Date(ts);%0Aif (isNaN(d.getTime())) return %22%22;%0Areturn d.toISOString().slice(0, 10);%0A}%0Avar d = new Date(ts > 1e12 ? ts : ts * 1000);%0Aif (isNaN(d.getTime())) return %22%22;%0Areturn d.toISOString().slice(0, 10);%0A}%0Avar modelCheckboxes = %22%22;%0Afor (var i = 0; i < modelKeys.length; i++) {%0Avar mk = modelKeys[i];%0AmodelCheckboxes += '<label class=%22g2c-model-row%22><input type=%22checkbox%22 checked data-model=%22' + mk + '%22> ' + mk + '<span class=%22cnt%22>' + models[mk] + '</span></label>';%0A}%0Avar sourceKeys = Object.keys(sources).sort(function(a, b) {%0Aif (a === %22Main conversations%22) return -1;%0Aif (b === %22Main conversations%22) return 1;%0Areturn sources[b] - sources[a];%0A});%0Avar sourceCheckboxes = %22%22;%0Avar hasProjects = sourceKeys.length > 1;%0Afor (var si = 0; si < sourceKeys.length; si++) {%0Avar sk = sourceKeys[si];%0Avar icon = sk === %22Main conversations%22 ? %22%5CuD83D%5CuDCAC%22 : %22%5CuD83D%5CuDCC1%22;%0AsourceCheckboxes += '<label class=%22g2c-model-row%22><input type=%22checkbox%22 checked data-source=%22' + sk + '%22> ' + icon + ' ' + sk + '<span class=%22cnt%22>' + sources[sk] + '</span></label>';%0A}%0Avar projCount = sourceKeys.length - 1;%0Avar projConvoCount = scannedConvos.filter(function(c) { return c._project; }).length;%0Avar mainCount = scannedConvos.length - projConvoCount;%0Avar scanSummaryText = scannedConvos.length.toLocaleString() + '</span>' +%0A'<span style=%22font-size:12px;color:#888;%22> conversations scanned</span>';%0Aif (projCount > 0) {%0AscanSummaryText += '<div style=%22font-size:11px;color:#7eb8a0;margin-top:4px;%22>' +%0AmainCount.toLocaleString() + ' main + ' + projConvoCount + ' from ' + projCount + ' project' + (projCount > 1 ? 's' : '') + '</div>';%0A}%0Avar scanSummary = '<div style=%22text-align:center;margin-bottom:14px;%22>' +%0A'<span style=%22font-size:28px;font-weight:800;color:#7eb8a0;%22>' + scanSummaryText +%0A'</div>';%0Avar hasRealModels = modelKeys.length > 1 || (modelKeys.length === 1 && modelKeys[0] !== %22unknown%22);%0Avar modelSection = '';%0Aif (hasRealModels) {%0AmodelSection = '%5C%0A<div class=%22g2c-filter-section%22>%5C%0A<div class=%22g2c-filter-label%22>Models</div>%5C%0A<div class=%22g2c-filter-models%22 id=%22g2c-filter-models%22>' + modelCheckboxes + '</div>%5C%0A<div class=%22g2c-select-btns%22><button id=%22g2c-sel-all%22>Select all</button> %5Cu00B7 <button id=%22g2c-sel-none%22>Select none</button></div>%5C%0A</div>';%0A}%0Avar filterHtml = '%5C%0A<div class=%22g2c-filter-panel%22 id=%22g2c-filter-panel%22>%5C%0A' + scanSummary + '%5C%0A' + (hasProjects ? '%5C%0A<div class=%22g2c-filter-section%22>%5C%0A<div class=%22g2c-filter-label%22>Source</div>%5C%0A<div class=%22g2c-filter-models%22 id=%22g2c-filter-sources%22>' + sourceCheckboxes + '</div>%5C%0A</div>' : '') + '%5C%0A' + modelSection + '%5C%0A<div class=%22g2c-filter-section%22>%5C%0A<div class=%22g2c-filter-label%22>Date range</div>%5C%0A<div class=%22g2c-filter-row%22>%5C%0A<input type=%22date%22 class=%22g2c-filter-input%22 id=%22g2c-date-from%22 value=%22' + tsToDate(oldest) + '%22>%5C%0A<span style=%22color:#555;%22>%5Cu2192</span>%5C%0A<input type=%22date%22 class=%22g2c-filter-input%22 id=%22g2c-date-to%22 value=%22' + tsToDate(newest) + '%22>%5C%0A</div>%5C%0A<div class=%22g2c-select-btns%22 id=%22g2c-era-btns%22 style=%22flex-wrap:wrap;margin-top:4px;%22>%5C%0A<button data-era=%22all%22>All</button> %5Cu00B7%5C%0A<button data-era=%22gpt35%22>GPT-3.5</button> %5Cu00B7%5C%0A<button data-era=%22gpt4%22>GPT-4</button> %5Cu00B7%5C%0A<button data-era=%22gpt4o%22>GPT-4o</button> %5Cu00B7%5C%0A<button data-era=%22gpt5%22>GPT-5+</button>%5C%0A</div>%5C%0A</div>%5C%0A<div class=%22g2c-filter-section%22>%5C%0A<div class=%22g2c-filter-label%22>Max conversations (0 = all)</div>%5C%0A<input type=%22number%22 class=%22g2c-filter-input%22 id=%22g2c-limit%22 value=%220%22 min=%220%22 style=%22width:100%;%22>%5C%0A</div>%5C%0A<div class=%22g2c-filter-section%22>%5C%0A<div class=%22g2c-filter-label%22>Incremental export (skip already exported)</div>%5C%0A<div class=%22g2c-filter-drop%22 id=%22g2c-prev-drop%22>Drop or click to load previous export</div>%5C%0A<input type=%22file%22 id=%22g2c-prev-file%22 accept=%22.json%22 style=%22display:none;%22>%5C%0A</div>%5C%0A<div class=%22g2c-filter-summary%22 id=%22g2c-filter-summary%22>' + scannedConvos.length + ' conversations selected</div>%5C%0A<button class=%22g2c-btn%22 id=%22g2c-btn-download%22 style=%22border-color:#d4a574;margin-bottom:0;%22>%5C%0A<div class=%22g2c-btn-icon%22>%5CuD83D%5CuDCE5</div>%5C%0A<div class=%22g2c-btn-text%22><span style=%22color:#d4a574;%22>Download ' + scannedConvos.length + ' conversations</span>%5C%0A<div class=%22g2c-btn-sub%22>~' + estimateTime(scannedConvos.length) + '</div>%5C%0A</div>%5C%0A</button>%5C%0A</div>';%0Avar bodyEl = panel.querySelector(%22.g2c-body%22);%0Aif (!bodyEl) {%0Alog(%22Warning: panel body not found%22, %22error%22);%0Areturn;%0A}%0Avar progressEl = document.getElementById(%22g2c-progress%22);%0Avar filterDiv = document.createElement(%22div%22);%0AfilterDiv.innerHTML = filterHtml;%0Avar filterPanel = filterDiv.firstElementChild || filterDiv.firstChild;%0Aif (progressEl && progressEl.parentNode) {%0AprogressEl.parentNode.insertBefore(filterPanel, progressEl);%0A} else {%0AbodyEl.appendChild(filterPanel);%0A}%0Avar hideIds = [%22g2c-btn-memory%22, %22g2c-btn-convos%22, %22g2c-btn-instructions%22, %22g2c-btn-all%22];%0Afor (var hi = 0; hi < hideIds.length; hi++) {%0Avar hideEl = document.getElementById(hideIds[hi]);%0Aif (hideEl) hideEl.style.display = %22none%22;%0A}%0Aif (hasRealModels) {%0AsafeAddEvent(%22g2c-sel-all%22, %22click%22, function() {%0Avar boxes = document.querySelectorAll(%22#g2c-filter-models input%22);%0Afor (var i = 0; i < boxes.length; i++) boxes[i].checked = true;%0AupdateFilterSummary();%0A});%0AsafeAddEvent(%22g2c-sel-none%22, %22click%22, function() {%0Avar boxes = document.querySelectorAll(%22#g2c-filter-models input%22);%0Afor (var i = 0; i < boxes.length; i++) boxes[i].checked = false;%0AupdateFilterSummary();%0A});%0A}%0AsafeAddEvent(%22g2c-prev-drop%22, %22click%22, function() {%0Avar fileInput = document.getElementById(%22g2c-prev-file%22);%0Aif (fileInput) fileInput.click();%0A});%0Avar filterInputs = document.querySelectorAll(%22#g2c-filter-models input, #g2c-filter-sources input, #g2c-date-from, #g2c-date-to, #g2c-limit%22);%0Afor (var fi = 0; fi < filterInputs.length; fi++) {%0AfilterInputs[fi].addEventListener(%22change%22, updateFilterSummary);%0A}%0Avar eraRanges = {%0A%22all%22: [tsToDate(oldest), tsToDate(newest)],%0A%22gpt35%22: [%222022-11-30%22, %222023-03-13%22],%0A%22gpt4%22: [%222023-03-14%22, %222024-05-12%22],%0A%22gpt4o%22: [%222024-05-13%22, %222025-08-06%22],%0A%22gpt5%22: [%222025-08-07%22, tsToDate(newest)]%0A};%0Avar eraBtns = document.querySelectorAll(%22#g2c-era-btns button%22);%0Afor (var ei = 0; ei < eraBtns.length; ei++) {%0AeraBtns[ei].addEventListener(%22click%22, function() {%0Avar era = this.getAttribute(%22data-era%22);%0Avar range = eraRanges[era];%0Aif (range) {%0Avar fromEl = document.getElementById(%22g2c-date-from%22);%0Avar toEl = document.getElementById(%22g2c-date-to%22);%0Aif (fromEl) fromEl.value = range[0];%0Aif (toEl) toEl.value = range[1];%0Avar siblings = document.querySelectorAll(%22#g2c-era-btns button%22);%0Afor (var si = 0; si < siblings.length; si++) siblings[si].style.color = %22%22;%0Athis.style.color = %22#d4a574%22;%0AupdateFilterSummary();%0A}%0A});%0A}%0AsafeAddEvent(%22g2c-prev-file%22, %22change%22, function() {%0Aif (this.files.length) loadPreviousExport(this.files[0]);%0A});%0Avar dropEl = document.getElementById(%22g2c-prev-drop%22);%0Aif (dropEl) {%0AdropEl.addEventListener(%22dragover%22, function(e) { e.preventDefault(); this.style.borderColor = %22#d4a574%22; });%0AdropEl.addEventListener(%22dragleave%22, function() { this.style.borderColor = %22%22; });%0AdropEl.addEventListener(%22drop%22, function(e) {%0Ae.preventDefault();%0Athis.style.borderColor = %22%22;%0Aif (e.dataTransfer.files.length) loadPreviousExport(e.dataTransfer.files[0]);%0A});%0A}%0AsafeAddEvent(%22g2c-btn-download%22, %22click%22, startFilteredDownload);%0Avar allBoxes = document.querySelectorAll(%22#g2c-filter-models input, #g2c-filter-sources input%22);%0Afor (var bi = 0; bi < allBoxes.length; bi++) allBoxes[bi].checked = true;%0AupdateFilterSummary();%0A}%0Afunction estimateTime(count) {%0Avar secs = Math.ceil(count / BATCH_SIZE) * 5;%0Aif (secs < 60) return %22~%22 + Math.max(Math.round(secs), 1) + %22 seconds%22;%0Avar mins = Math.round(secs / 60);%0Aif (mins < 60) return %22~%22 + mins + %22 minutes%22;%0Avar hrs = (secs / 3600).toFixed(1);%0Areturn %22~%22 + hrs + %22 hours%22;%0A}%0Afunction getFilteredConvos() {%0Atry {%0Avar selectedModels = {};%0Avar boxes = document.querySelectorAll(%22#g2c-filter-models input%22);%0Afor (var i = 0; i < boxes.length; i++) {%0Aif (boxes[i].checked) selectedModels[boxes[i].getAttribute(%22data-model%22)] = true;%0A}%0Avar selectedSources = {};%0Avar sourceBoxes = document.querySelectorAll(%22#g2c-filter-sources input%22);%0Afor (var si = 0; si < sourceBoxes.length; si++) {%0Aif (sourceBoxes[si].checked) selectedSources[sourceBoxes[si].getAttribute(%22data-source%22)] = true;%0A}%0Avar hasSourceFilter = sourceBoxes.length > 0 && Object.keys(selectedSources).length > 0;%0Avar hasModelFilter = Object.keys(selectedModels).length > 0;%0Avar fromEl = document.getElementById(%22g2c-date-from%22);%0Avar toEl = document.getElementById(%22g2c-date-to%22);%0Avar limitEl = document.getElementById(%22g2c-limit%22);%0Avar fromStr = fromEl ? fromEl.value : %22%22;%0Avar toStr = toEl ? toEl.value : %22%22;%0Avar fromTs = fromStr ? new Date(fromStr + %22T00:00:00%22).getTime() / 1000 : 0;%0Avar toTs = toStr ? new Date(toStr + %22T23:59:59%22).getTime() / 1000 : Infinity;%0Avar limit = limitEl ? (parseInt(limitEl.value) || 0) : 0;%0Avar filtered = [];%0Avar mainCount = 0;%0Afor (var i = 0; i < scannedConvos.length; i++) {%0Avar c = scannedConvos[i];%0Aif (hasSourceFilter) {%0Avar src = c._project || %22Main conversations%22;%0Aif (!selectedSources[src]) continue;%0A}%0Avar model = getConvoModel(c);%0Aif (hasModelFilter && !selectedModels[model]) continue;%0Avar ts = getConvoTime(c);%0Aif (ts > 0 && (ts < fromTs || ts > toTs)) continue;%0Aif (previousExportIds[c.id]) continue;%0Aif (!c._project) {%0Aif (limit > 0 && mainCount >= limit) continue;%0AmainCount++;%0A}%0Afiltered.push(c);%0A}%0Areturn filtered;%0A} catch (err) {%0Alog(%22Filter error: %22 + err.message, %22error%22);%0Areturn scannedConvos; // fail-open: return all%0A}%0A}%0Afunction updateFilterSummary() {%0Avar filtered = getFilteredConvos();%0Avar summary = document.getElementById(%22g2c-filter-summary%22);%0Avar dlBtn = document.getElementById(%22g2c-btn-download%22);%0Avar skipped = Object.keys(previousExportIds).length;%0Avar text = filtered.length + %22 conversations selected%22;%0Aif (skipped > 0) text += %22 (%22 + skipped + %22 skipped from previous export)%22;%0Aif (summary) summary.textContent = text;%0Aif (dlBtn) {%0Avar spanEl = dlBtn.querySelector(%22.g2c-btn-text span%22);%0Aif (spanEl) spanEl.textContent = %22Download %22 + filtered.length + %22 conversations%22;%0Avar subEl = dlBtn.querySelector(%22.g2c-btn-sub%22);%0Aif (subEl) subEl.textContent = estimateTime(filtered.length);%0A}%0A}%0Afunction loadPreviousExport(file) {%0Avar dropEl = document.getElementById(%22g2c-prev-drop%22);%0Aif (dropEl) dropEl.textContent = %22Loading %22 + file.name + %22...%22;%0Avar reader = new FileReader();%0Areader.onload = function(e) {%0Atry {%0Avar data = JSON.parse(e.target.result);%0Avar convos = data.conversations || data || [];%0Aif (Array.isArray(convos)) {%0ApreviousExportIds = {};%0Afor (var i = 0; i < convos.length; i++) {%0Aif (convos[i].id) previousExportIds[convos[i].id] = true;%0A}%0Aif (dropEl) {%0AdropEl.textContent = %22%5Cu2705 %22 + Object.keys(previousExportIds).length + %22 conversations from previous export%22;%0AdropEl.className = %22g2c-filter-drop active%22;%0A}%0Alog(%22Loaded previous export: %22 + Object.keys(previousExportIds).length + %22 conversation IDs%22);%0AupdateFilterSummary();%0A}%0A} catch (err) {%0Aif (dropEl) dropEl.textContent = %22%5Cu274C Could not parse file%22;%0Alog(%22Previous export error: %22 + err.message, %22error%22);%0A}%0A};%0Areader.readAsText(file);%0A}%0Afunction extractNodeText(node) {%0Aif (!node || !node.message || !node.message.content) return %22%22;%0Avar content = node.message.content;%0Avar ct = content.content_type;%0Aif (ct === %22model_editable_context%22) return %22%22; // system memory, skip%0Aif (ct === %22thoughts%22) {%0Areturn %22[thinking]%22;%0A}%0Aif (ct === %22reasoning_recap%22) {%0Areturn %22[%22 + (content.content || %22Thinking...%22) + %22]%22;%0A}%0Aif (ct === %22code%22 || ct === %22execution_output%22) {%0Avar lang = content.language || %22%22;%0Avar codeText = content.text || %22%22;%0Aif (lang === %22unknown%22 && codeText.indexOf(%22search(%22) === 0) {%0Areturn %22[%5CuD83D%5CuDD0D %22 + codeText + %22]%22;%0A}%0Areturn %22```%22 + lang + %22%5Cn%22 + codeText + %22%5Cn```%22;%0A}%0Avar parts = content.parts;%0Aif (!Array.isArray(parts)) return JSON.stringify(content);%0Avar textParts = [];%0Afor (var p = 0; p < parts.length; p++) {%0Aif (typeof parts[p] === %22string%22) {%0AtextParts.push(parts[p]);%0A} else if (parts[p] && typeof parts[p] === %22object%22) {%0Aif (parts[p].content_type === %22image_asset_pointer%22 || parts[p].asset_pointer) {%0Avar imgName = (parts[p].metadata && parts[p].metadata.dalle && parts[p].metadata.dalle.prompt)%0A? %22DALL-E: %22 + parts[p].metadata.dalle.prompt : %22image%22;%0AtextParts.push(%22[%5CuD83D%5CuDDBC %22 + imgName + %22]%22);%0A}%0A}%0A}%0Areturn textParts.join(%22%5Cn%22)%0A.replace(/%5CuE200cite(%5CuE202turn%5Cdsearch%5Cd+)+%5CuE201/g, %22%22)%0A.replace(/%5CuE200image_group%5CuE202%5C{[^}]*%5C}%5CuE201/g, %22[%F0%9F%96%BC images]%22)%0A.replace(/%5CuE200[%5Cs%5CS]*?%5CuE201/g, %22%22);%0A}%0Afunction extractNodeRole(node) {%0Areturn (node.message && node.message.author && node.message.author.role) || %22unknown%22;%0A}%0Afunction extractNodeModel(node) {%0Areturn (node.message && node.message.metadata && node.message.metadata.model_slug) || null;%0A}%0Afunction extractNodeTime(node) {%0Areturn (node.message && node.message.create_time) || null;%0A}%0Afunction processConversationDetail(detail, listItem) {%0Avar messages = [];%0Avar hasBranches = false;%0Aif (detail.mapping) {%0Avar mapKeys = Object.keys(detail.mapping);%0Avar rootId = null;%0Afor (var mk = 0; mk < mapKeys.length; mk++) {%0Aif (!detail.mapping[mapKeys[mk]].parent) {%0ArootId = mapKeys[mk];%0Abreak;%0A}%0A}%0Aif (!rootId) rootId = mapKeys[0];%0Avar current = rootId;%0Avar visited = {};%0Avar safety = 0;%0Awhile (current && safety < 50000) {%0Asafety++;%0Aif (visited[current]) break;%0Avisited[current] = true;%0Avar node = detail.mapping[current];%0Aif (!node) break;%0Aif (node.message && node.message.content) {%0Avar text = extractNodeText(node);%0Aif (text.trim() !== %22%22) {%0Avar msgObj = {%0Arole: extractNodeRole(node),%0Acontent: text,%0Atimestamp: extractNodeTime(node),%0Amodel: extractNodeModel(node)%0A};%0Aif (node.parent && detail.mapping[node.parent]) {%0Avar parentNode = detail.mapping[node.parent];%0Aif (parentNode.children && parentNode.children.length > 1) {%0Avar alts = [];%0Afor (var ci = 0; ci < parentNode.children.length; ci++) {%0Avar sibId = parentNode.children[ci];%0Aif (sibId === current) continue;%0Avar sib = detail.mapping[sibId];%0Aif (sib && sib.message && sib.message.content) {%0Avar sibText = extractNodeText(sib);%0Aif (sibText.trim()) {%0Aalts.push({%0Acontent: sibText,%0Arole: extractNodeRole(sib),%0Atimestamp: extractNodeTime(sib),%0Amodel: extractNodeModel(sib)%0A});%0A}%0A}%0A}%0Aif (alts.length > 0) {%0AmsgObj.alternatives = alts;%0AhasBranches = true;%0A}%0A}%0A}%0Amessages.push(msgObj);%0A}%0A}%0Aif (node.children && node.children.length > 0) {%0Acurrent = node.children[node.children.length - 1];%0A} else {%0Abreak;%0A}%0A}%0A}%0Avar model = detail.default_model_slug || null;%0Aif (!model && detail.mapping) {%0Avar mKeys = Object.keys(detail.mapping);%0Afor (var mi = 0; mi < mKeys.length; mi++) {%0Avar mNode = detail.mapping[mKeys[mi]];%0Aif (mNode && mNode.message && mNode.message.metadata && mNode.message.metadata.model_slug) {%0Amodel = mNode.message.metadata.model_slug;%0Abreak;%0A}%0A}%0A}%0Areturn {%0Aid: detail.conversation_id || (listItem && listItem.id) || detail.id,%0Atitle: detail.title || (listItem && listItem.title) || %22Untitled%22,%0Acreate_time: detail.create_time || (listItem && listItem.create_time) || null,%0Aupdate_time: detail.update_time || (listItem && listItem.update_time) || null,%0Amodel: model,%0Aproject: (listItem && listItem._project) || null,%0Aproject_id: (listItem && listItem._project_id) || null,%0Ahas_branches: hasBranches,%0Amessage_count: messages.length,%0Amessages: messages%0A};%0A}%0Afunction updateDlUI(completed, total, title, startTime) {%0Avar pct = Math.round((completed / total) * 100);%0Avar remaining = total - completed;%0Avar dlCount = document.getElementById(%22g2c-dl-count%22);%0Avar dlTitle = document.getElementById(%22g2c-dl-title%22);%0Avar dlFill = document.getElementById(%22g2c-dl-fill%22);%0Avar dlPct = document.getElementById(%22g2c-dl-pct%22);%0Avar dlRemaining = document.getElementById(%22g2c-dl-remaining%22);%0Avar dlMode = document.getElementById(%22g2c-dl-mode%22);%0Aif (dlCount) dlCount.textContent = completed;%0Aif (dlTitle) dlTitle.textContent = title;%0Aif (dlFill) dlFill.style.width = pct + %22%%22;%0Aif (dlPct) dlPct.textContent = pct + %22%%22;%0Aif (dlRemaining && completed > 0) {%0Avar elapsed = (Date.now() - startTime) / 1000;%0Avar perItem = elapsed / completed;%0Avar secsLeft = Math.round(perItem * remaining);%0Aif (secsLeft < 60) {%0AdlRemaining.textContent = %22~%22 + secsLeft + %22 seconds remaining%22;%0A} else {%0AdlRemaining.textContent = %22~%22 + Math.round(secsLeft / 60) + %22 minutes remaining%22;%0A}%0A}%0A}%0Aasync function downloadBatch(ids, token) {%0Avar resp = await fetch(%22https://chatgpt.com/backend-api/conversations/batch%22, {%0Amethod: %22POST%22,%0Acredentials: %22include%22,%0Aheaders: {%22Authorization%22: %22Bearer %22 + token, %22Content-Type%22: %22application/json%22},%0Abody: JSON.stringify({conversation_ids: ids})%0A});%0Areturn resp;%0A}%0Aasync function downloadSingle(id, token) {%0Avar resp = await fetch(%22https://chatgpt.com/backend-api/conversation/%22 + id, {%0Acredentials: %22include%22,%0Aheaders: {%22Authorization%22: %22Bearer %22 + token}%0A});%0Areturn resp;%0A}%0Aasync function startFilteredDownload() {%0Avar filtered = getFilteredConvos();%0Aif (filtered.length === 0) {%0Aalert(%22No conversations selected. Adjust your filters.%22);%0Areturn;%0A}%0Avar filterPanel = document.getElementById(%22g2c-filter-panel%22);%0Aif (filterPanel) {%0AfilterPanel.innerHTML = '%5C%0A<div class=%22g2c-dl-hero%22 id=%22g2c-dl-hero%22>%5C%0A<span class=%22g2c-dl-count%22 id=%22g2c-dl-count%22>0</span>%5C%0A<span class=%22g2c-dl-of%22 id=%22g2c-dl-of%22> / ' + filtered.length + '</span>%5C%0A<div class=%22g2c-dl-title%22 id=%22g2c-dl-title%22>Starting download%5Cu2026</div>%5C%0A</div>%5C%0A<div style=%22margin:10px 0;%22>%5C%0A<div class=%22g2c-progress-bar%22><div class=%22g2c-progress-fill%22 id=%22g2c-dl-fill%22 style=%22width:0%;%22></div></div>%5C%0A<div class=%22g2c-dl-pct%22 id=%22g2c-dl-pct%22>0%</div>%5C%0A</div>%5C%0A<div class=%22g2c-dl-remaining%22 id=%22g2c-dl-remaining%22></div>%5C%0A<div class=%22g2c-dl-mode%22 id=%22g2c-dl-mode%22 style=%22text-align:center;font-size:10px;color:#666;margin-top:4px;%22></div>';%0A}%0Avar startTime = Date.now();%0Atry {%0Avar token = await getToken();%0Avar fullExport = {%0Aexport_date: new Date().toISOString(),%0Atool: %22GPT2Claude Migration Kit v2.3%22,%0Aformat_version: 3,%0Atotal_conversations: filtered.length,%0Aconversations: []%0A};%0Avar successCount = 0;%0Avar errorCount = 0;%0Avar useBatch = true;%0Avar listLookup = {};%0Afor (var li = 0; li < filtered.length; li++) {%0AlistLookup[filtered[li].id] = filtered[li];%0A}%0Alog(%22Using batch download (10 at a time)%5Cu2026%22);%0Avar dlMode = document.getElementById(%22g2c-dl-mode%22);%0Aif (dlMode) dlMode.textContent = %22%5Cu26A1 Batch mode %5Cu2014 10x faster%22;%0Avar batchIndex = 0;%0Avar consecutiveGroupFails = 0;%0Avar MAX_CONSECUTIVE_FAILS = 3;%0Aasync function downloadIndividually(items, tkn) {%0Avar results = [];%0Afor (var ii = 0; ii < items.length; ii++) {%0Atry {%0Avar resp = await downloadSingle(items[ii].id, tkn);%0Aif (resp.status === 429) {%0Alog(%22Rate limited, waiting 30s%5Cu2026%22, %22error%22);%0Aawait new Promise(function(r) { setTimeout(r, 30000); });%0Aii--; continue;%0A}%0Aif (resp.status !== 200) {%0Aresults.push({error: %22HTTP %22 + resp.status, item: items[ii]});%0Acontinue;%0A}%0Avar det = await resp.json();%0Aresults.push({detail: det, item: items[ii]});%0A} catch (e) {%0Aresults.push({error: e.message, item: items[ii]});%0A}%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A}%0Areturn results;%0A}%0Aasync function tryBatch(ids, tkn) {%0Atry {%0Avar resp = await downloadBatch(ids, tkn);%0Aif (resp.status === 200) {%0Avar d = await resp.json();%0Areturn {ok: true, data: d, status: 200};%0A}%0Areturn {ok: false, data: null, status: resp.status};%0A} catch (e) {%0Areturn {ok: false, data: null, status: 0, error: e.message};%0A}%0A}%0Awhile (batchIndex < filtered.length && useBatch) {%0Avar batchItems = filtered.slice(batchIndex, batchIndex + BATCH_SIZE);%0Avar batchIds = [];%0Afor (var bi = 0; bi < batchItems.length; bi++) batchIds.push(batchItems[bi].id);%0Avar result = await tryBatch(batchIds, token);%0Aif (result.status === 429) {%0Alog(%22Rate limited, waiting 30s%5Cu2026%22, %22error%22);%0Avar dlTitle = document.getElementById(%22g2c-dl-title%22);%0Avar dlRemaining = document.getElementById(%22g2c-dl-remaining%22);%0Aif (dlTitle) dlTitle.textContent = %22Rate limited %5Cu2014 waiting 30s%5Cu2026%22;%0Aif (dlRemaining) dlRemaining.textContent = %22Will resume automatically%22;%0Aawait new Promise(function(r) { setTimeout(r, 30000); });%0Acontinue; // retry same batch%0A}%0Aif (result.status === 422 || result.status === 405 || result.status === 404) {%0Alog(%22Batch endpoint unavailable (HTTP %22 + result.status + %22), falling back to individual downloads%5Cu2026%22, %22error%22);%0AuseBatch = false;%0Abreak;%0A}%0Aif (result.ok) {%0AconsecutiveGroupFails = 0;%0Avar batchData = result.data;%0Avar batchArr = Array.isArray(batchData) ? batchData : Object.values(batchData);%0Afor (var bj = 0; bj < batchArr.length; bj++) {%0Atry {%0Avar detail = batchArr[bj];%0Avar detailId = detail.conversation_id || detail.id;%0Avar listItem = listLookup[detailId] || batchItems[bj];%0Avar processed = processConversationDetail(detail, listItem);%0AfullExport.conversations.push(processed);%0AsuccessCount++;%0A} catch (procErr) {%0Avar errTitle = (batchItems[bj] && batchItems[bj].title) || %22Unknown%22;%0Alog(%22Error processing: %22 + errTitle + %22 %5Cu2014 %22 + procErr.message, %22error%22);%0AerrorCount++;%0AfullExport.conversations.push({%0Aid: batchIds[bj],%0Atitle: errTitle,%0Aerror: procErr.message%0A});%0A}%0A}%0AbatchIndex += BATCH_SIZE;%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A} else {%0Alog(%22Batch error (HTTP %22 + (result.status || result.error) + %22), retrying in 3s%5Cu2026%22, %22error%22);%0Aif (dlMode) dlMode.textContent = %22%5Cu26A1 Retrying batch%5Cu2026%22;%0Aawait new Promise(function(r) { setTimeout(r, 3000); });%0Avar retry = await tryBatch(batchIds, token);%0Aif (retry.ok) {%0AconsecutiveGroupFails = 0;%0Avar retryArr = Array.isArray(retry.data) ? retry.data : Object.values(retry.data);%0Afor (var rj = 0; rj < retryArr.length; rj++) {%0Atry {%0Avar det = retryArr[rj];%0Avar detId = det.conversation_id || det.id;%0Avar li = listLookup[detId] || batchItems[rj];%0AfullExport.conversations.push(processConversationDetail(det, li));%0AsuccessCount++;%0A} catch (e) {%0AerrorCount++;%0AfullExport.conversations.push({id: batchIds[rj], title: (batchItems[rj] && batchItems[rj].title) || %22Unknown%22, error: e.message});%0A}%0A}%0AbatchIndex += BATCH_SIZE;%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A} else if (batchIds.length > 1) {%0Alog(%22Retry failed, splitting batch%5Cu2026%22, %22error%22);%0Aif (dlMode) dlMode.textContent = %22%5Cu26A1 Splitting batch%5Cu2026%22;%0Avar mid = Math.ceil(batchIds.length / 2);%0Avar halfA = batchIds.slice(0, mid);%0Avar halfB = batchIds.slice(mid);%0Avar itemsA = batchItems.slice(0, mid);%0Avar itemsB = batchItems.slice(mid);%0Avar anyHalfFailed = false;%0Avar halves = [{ids: halfA, items: itemsA}, {ids: halfB, items: itemsB}];%0Afor (var hi = 0; hi < halves.length; hi++) {%0Avar halfResult = await tryBatch(halves[hi].ids, token);%0Aif (halfResult.ok) {%0Avar halfArr = Array.isArray(halfResult.data) ? halfResult.data : Object.values(halfResult.data);%0Afor (var hj = 0; hj < halfArr.length; hj++) {%0Atry {%0Avar hDet = halfArr[hj];%0Avar hId = hDet.conversation_id || hDet.id;%0Avar hLi = listLookup[hId] || halves[hi].items[hj];%0AfullExport.conversations.push(processConversationDetail(hDet, hLi));%0AsuccessCount++;%0A} catch (e) {%0AerrorCount++;%0AfullExport.conversations.push({id: halves[hi].ids[hj], title: (halves[hi].items[hj] && halves[hi].items[hj].title) || %22Unknown%22, error: e.message});%0A}%0A}%0A} else {%0AanyHalfFailed = true;%0Alog(%22Half-batch failed, downloading %22 + halves[hi].ids.length + %22 individually%5Cu2026%22, %22error%22);%0Avar indResults = await downloadIndividually(halves[hi].items, token);%0Afor (var ir = 0; ir < indResults.length; ir++) {%0Aif (indResults[ir].detail) {%0Atry {%0AfullExport.conversations.push(processConversationDetail(indResults[ir].detail, indResults[ir].item));%0AsuccessCount++;%0A} catch (e) {%0AerrorCount++;%0AfullExport.conversations.push({id: indResults[ir].item.id, title: indResults[ir].item.title || %22Unknown%22, error: e.message});%0A}%0A} else {%0AerrorCount++;%0AfullExport.conversations.push({id: indResults[ir].item.id, title: indResults[ir].item.title || %22Unknown%22, error: indResults[ir].error});%0A}%0A}%0A}%0Aawait new Promise(function(r) { setTimeout(r, 500); });%0A}%0Aif (anyHalfFailed) {%0AconsecutiveGroupFails++;%0Alog(%22Batch group recovered individually, resuming batch mode (%22 + consecutiveGroupFails + %22/%22 + MAX_CONSECUTIVE_FAILS + %22 fails)%22, %22error%22);%0A} else {%0AconsecutiveGroupFails = 0;%0A}%0AbatchIndex += BATCH_SIZE;%0A} else {%0Avar singleResults = await downloadIndividually(batchItems, token);%0Afor (var sr = 0; sr < singleResults.length; sr++) {%0Aif (singleResults[sr].detail) {%0Atry {%0AfullExport.conversations.push(processConversationDetail(singleResults[sr].detail, singleResults[sr].item));%0AsuccessCount++;%0A} catch (e) {%0AerrorCount++;%0AfullExport.conversations.push({id: singleResults[sr].item.id, title: singleResults[sr].item.title || %22Unknown%22, error: e.message});%0A}%0A} else {%0AerrorCount++;%0AfullExport.conversations.push({id: singleResults[sr].item.id, title: singleResults[sr].item.title || %22Unknown%22, error: singleResults[sr].error});%0A}%0A}%0AconsecutiveGroupFails++;%0AbatchIndex += BATCH_SIZE;%0A}%0Aif (consecutiveGroupFails >= MAX_CONSECUTIVE_FAILS) {%0Alog(%22Too many consecutive batch failures (%22 + MAX_CONSECUTIVE_FAILS + %22), switching to individual mode%22, %22error%22);%0AuseBatch = false;%0A} else if (consecutiveGroupFails > 0) {%0Aif (dlMode) dlMode.textContent = %22%5Cu26A1 Batch mode %5Cu2014 resumed%22;%0A}%0A}%0Avar completed = successCount + errorCount;%0Avar lastTitle = batchItems[batchItems.length - 1].title || %22Untitled%22;%0AupdateDlUI(completed, filtered.length, lastTitle, startTime);%0Aif (completed % 100 === 0 || completed === filtered.length) {%0Alog(%22Progress: %22 + completed + %22/%22 + filtered.length);%0A}%0A}%0Aif (!useBatch) {%0Aif (dlMode) dlMode.textContent = %22%5CuD83D%5CuDC22 Individual mode%22;%0Alog(%22Switching to individual downloads%5Cu2026%22);%0Avar startFrom = successCount + errorCount;%0Afor (var i = startFrom; i < filtered.length; i++) {%0Avar c = filtered[i];%0Avar title = c.title || %22Untitled%22;%0AupdateDlUI(i + 1, filtered.length, title, startTime);%0Atry {%0Avar convoResp = await downloadSingle(c.id, token);%0Aif (convoResp.status === 429) {%0Alog(%22Rate limited, waiting 30s%5Cu2026%22, %22error%22);%0Avar dlTitle = document.getElementById(%22g2c-dl-title%22);%0Avar dlRemaining = document.getElementById(%22g2c-dl-remaining%22);%0Aif (dlTitle) dlTitle.textContent = %22Rate limited %5Cu2014 waiting 30s%5Cu2026%22;%0Aif (dlRemaining) dlRemaining.textContent = %22Will resume automatically%22;%0Aawait new Promise(function(r) { setTimeout(r, 30000); });%0Ai--;%0Acontinue;%0A}%0Aif (convoResp.status !== 200) {%0Alog(%22Skipped: %22 + title + %22 (HTTP %22 + convoResp.status + %22)%22, %22error%22);%0AerrorCount++;%0AfullExport.conversations.push({id: c.id, title: title, error: %22HTTP %22 + convoResp.status});%0Acontinue;%0A}%0Avar detail = await convoResp.json();%0Avar processed = processConversationDetail(detail, c);%0AfullExport.conversations.push(processed);%0AsuccessCount++;%0Aif (i % 25 === 0 && i > 0) {%0Alog(%22Progress: %22 + (i + 1) + %22/%22 + filtered.length);%0A}%0A} catch (err) {%0Alog(%22Error: %22 + title + %22 %5Cu2014 %22 + err.message, %22error%22);%0AerrorCount++;%0AfullExport.conversations.push({id: c.id, title: title, error: err.message});%0A}%0Aawait new Promise(function(r) { setTimeout(r, 1000); });%0A}%0A}%0Avar json = JSON.stringify(fullExport, null, 2);%0Avar sizeMB = (json.length / 1024 / 1024).toFixed(1);%0Avar exportFilename = %22chatgpt_all_conversations.json%22;%0Avar projectNames = {};%0Avar hasMain = false;%0Afor (var fi = 0; fi < fullExport.conversations.length; fi++) {%0Aif (fullExport.conversations[fi].project) {%0AprojectNames[fullExport.conversations[fi].project] = true;%0A} else {%0AhasMain = true;%0A}%0A}%0Avar projNameList = Object.keys(projectNames);%0Aif (!hasMain && projNameList.length === 1) {%0AexportFilename = %22chatgpt_project_%22 + projNameList[0].toLowerCase().replace(/[^a-z0-9]+/g, %22_%22) + %22.json%22;%0A} else if (!hasMain && projNameList.length > 1) {%0AexportFilename = %22chatgpt_projects.json%22;%0A}%0AdownloadFile(json, exportFilename, %22application/json%22);%0Alog(%22DONE! %22 + successCount + %22 conversations, %22 + errorCount + %22 errors, ~%22 + sizeMB + %22 MB%22, %22success%22);%0Avar modelBreakdown = {};%0Afor (var mi = 0; mi < fullExport.conversations.length; mi++) {%0Avar cm = fullExport.conversations[mi].model || %22unknown%22;%0AmodelBreakdown[cm] = (modelBreakdown[cm] || 0) + 1;%0A}%0Avar sortedModels = Object.keys(modelBreakdown).sort(function(a, b) {%0Areturn modelBreakdown[b] - modelBreakdown[a];%0A});%0Avar TOP_N = 5;%0Avar modelTagsHtml = '<div class=%22g2c-complete-models-wrap%22>';%0Afor (var ti = 0; ti < Math.min(TOP_N, sortedModels.length); ti++) {%0Avar mk = sortedModels[ti];%0AmodelTagsHtml += '<span class=%22g2c-scan-tag%22>' + mk + ' <span style=%22opacity:0.6;%22>' + modelBreakdown[mk] + '</span></span>';%0A}%0Aif (sortedModels.length > TOP_N) {%0Avar moreCount = sortedModels.length - TOP_N;%0AmodelTagsHtml += '<button class=%22g2c-models-toggle%22 id=%22g2c-models-toggle%22>+' + moreCount + ' more</button>';%0AmodelTagsHtml += '<div class=%22g2c-models-extra%22 id=%22g2c-models-extra%22 style=%22display:none;%22>';%0Afor (var ti = TOP_N; ti < sortedModels.length; ti++) {%0Avar mk = sortedModels[ti];%0AmodelTagsHtml += '<span class=%22g2c-scan-tag%22>' + mk + ' <span style=%22opacity:0.6;%22>' + modelBreakdown[mk] + '</span></span>';%0A}%0AmodelTagsHtml += '</div>';%0A}%0AmodelTagsHtml += '</div>';%0Avar filterPanel = document.getElementById(%22g2c-filter-panel%22);%0Aif (filterPanel) {%0Avar elapsed = Math.round((Date.now() - startTime) / 1000);%0Avar elapsedStr = elapsed < 60 ? elapsed + %22s%22 : Math.round(elapsed / 60) + %22m %22 + (elapsed % 60) + %22s%22;%0AfilterPanel.innerHTML = '%5C%0A<div class=%22g2c-complete%22>%5C%0A<div class=%22g2c-complete-icon%22>%5Cu2705</div>%5C%0A<div class=%22g2c-complete-title%22>Export Complete!</div>%5C%0A<div class=%22g2c-complete-sub%22>' + successCount + ' conversations %5Cu00B7 ' + sizeMB + ' MB %5Cu00B7 ' + elapsedStr + '</div>%5C%0A' + modelTagsHtml + '%5C%0A</div>%5C%0A<div class=%22g2c-whatsnext%22>%5C%0A<div class=%22g2c-whatsnext-title%22>What%5Cu2019s next?</div>%5C%0A<div class=%22g2c-whatsnext-item%22>%5C%0A<span style=%22color:#a0a0e0;%22>%5CuD83D%5CuDC40 Browse your data</span><br>%5C%0A<span style=%22color:#999;%22>Open the <a href=%22https://siamsnus.github.io/GPT2Claude-Migration-Kit/viewer.html%22 target=%22_blank%22>Conversation Viewer</a> to explore your chats. You can <a href=%22https://siamsnus.github.io/GPT2Claude-Migration-Kit/viewer.html%22 download target=%22_blank%22>download it</a> for fully offline use.</span>%5C%0A</div>%5C%0A<div class=%22g2c-whatsnext-item%22>%5C%0A<span style=%22color:#7eb8a0;%22>%5CuD83D%5CuDE80 Import to Claude</span> <span class=%22g2c-whatsnext-badge%22>recommended</span><br>%5C%0A<span style=%22color:#999;%22>Follow the <a href=%22https://siamsnus.github.io/GPT2Claude-Migration-Kit/#importing%22 target=%22_blank%22>import guide</a> to bring your history into Claude.</span>%5C%0A</div>%5C%0A</div>';%0Avar modelsToggle = document.getElementById(%22g2c-models-toggle%22);%0Aif (modelsToggle) {%0AmodelsToggle.addEventListener(%22click%22, function() {%0Avar extra = document.getElementById(%22g2c-models-extra%22);%0Aif (extra) {%0Avar showing = extra.style.display !== %22none%22;%0Aextra.style.display = showing ? %22none%22 : %22flex%22;%0Athis.textContent = showing ? %22+%22 + (sortedModels.length - TOP_N) + %22 more%22 : %22show less%22;%0A}%0A});%0A}%0A}%0A} catch (err) {%0Alog(%22Download failed: %22 + err.message, %22error%22);%0Avar dlTitle = document.getElementById(%22g2c-dl-title%22);%0Aif (dlTitle) dlTitle.textContent = %22Error: %22 + err.message;%0A}%0A}%0Aasync function exportInstructions() {%0Avar btn = document.getElementById(%22g2c-btn-instructions%22);%0AsetButtonState(btn, %22running%22, %22Exporting...%22);%0Atry {%0Avar token = await getToken();%0Avar headers = {%22Authorization%22: %22Bearer %22 + token};%0Avar endpoints = [%0A{name: %22custom_instructions%22, url: %22https://chatgpt.com/backend-api/user_system_messages%22},%0A{name: %22settings%22, url: %22https://chatgpt.com/backend-api/settings%22}%0A];%0Avar result = {%0Aexport_date: new Date().toISOString(),%0Atool: %22GPT2Claude Migration Kit v2.3%22,%0Adata: {}%0A};%0Afor (var i = 0; i < endpoints.length; i++) {%0Avar ep = endpoints[i];%0Alog(%22Fetching %22 + ep.name + %22...%22);%0Atry {%0Avar resp = await fetch(ep.url, {credentials: %22include%22, headers: headers});%0Aif (resp.status === 200) {%0Aresult.data[ep.name] = await resp.json();%0Alog(%22Got: %22 + ep.name);%0A} else if (resp.status === 404) {%0Aresult.data[ep.name] = {note: %22Not available on this account%22};%0Alog(ep.name + %22: not available (skipped)%22);%0A} else {%0Aresult.data[ep.name] = {error: %22HTTP %22 + resp.status};%0Alog(ep.name + %22: HTTP %22 + resp.status, %22error%22);%0A}%0A} catch (e) {%0Aresult.data[ep.name] = {error: e.message};%0Alog(ep.name + %22 error: %22 + e.message, %22error%22);%0A}%0A}%0AdownloadFile(JSON.stringify(result, null, 2), %22chatgpt_instructions.json%22, %22application/json%22);%0AsetButtonState(btn, %22done%22, %22Instructions exported%22);%0A} catch (err) {%0Alog(%22Instructions export failed: %22 + err.message, %22error%22);%0AsetButtonState(btn, %22error%22, err.message);%0A}%0A}%0Adocument.getElementById(%22g2c-close%22).addEventListener(%22click%22, function() {%0Apanel.style.animation = %22g2c-fadein 0.2s ease-out reverse%22;%0AsetTimeout(function() { panel.remove(); style.remove(); }, 200);%0A});%0Adocument.getElementById(%22g2c-btn-memory%22).addEventListener(%22click%22, exportMemories);%0Adocument.getElementById(%22g2c-btn-convos%22).addEventListener(%22click%22, exportConversations);%0Adocument.getElementById(%22g2c-btn-instructions%22).addEventListener(%22click%22, exportInstructions);%0Adocument.getElementById(%22g2c-btn-all%22).addEventListener(%22click%22, async function() {%0Avar btn = document.getElementById(%22g2c-btn-all%22);%0AsetButtonState(btn, %22running%22, %22Exporting everything...%22);%0Alog(%22--- EXPORT ALL started ---%22);%0Aawait exportMemories();%0Aawait exportInstructions();%0Alog(%22Memories & instructions done. Scanning conversations...%22);%0Aawait exportConversations();%0Alog(%22Memories & instructions exported. Configure conversation filters and click Download.%22, %22success%22);%0A});%0Adocument.getElementById(%22g2c-toggle-log%22).addEventListener(%22click%22, function() {%0Avar logVisible = logEl.classList.contains(%22visible%22);%0AlogEl.classList.toggle(%22visible%22);%0Athis.textContent = logVisible ? %22Show log %5Cu25BC%22 : %22Hide log %5Cu25B2%22;%0A});%0Adocument.getElementById(%22g2c-copy-log%22).addEventListener(%22click%22, function() {%0Avar copyBtn = this;%0Avar entries = document.querySelectorAll(%22.g2c-log-entry%22);%0Avar text = %22%22;%0Afor (var i = 0; i < entries.length; i++) {%0Atext += entries[i].textContent + %22%5Cn%22;%0A}%0Aif (navigator.clipboard && navigator.clipboard.writeText) {%0Anavigator.clipboard.writeText(text).then(function() {%0AcopyBtn.textContent = %22%5Cu2705 Copied!%22;%0AsetTimeout(function() { copyBtn.textContent = %22Copy log%22; }, 2000);%0A}).catch(function() {%0AfallbackCopy(text, copyBtn);%0A});%0A} else {%0AfallbackCopy(text, copyBtn);%0A}%0A});%0Afunction fallbackCopy(text, btn) {%0Avar ta = document.createElement(%22textarea%22);%0Ata.value = text;%0Ata.style.position = %22fixed%22;%0Ata.style.left = %22-9999px%22;%0Adocument.body.appendChild(ta);%0Ata.select();%0Atry {%0Adocument.execCommand(%22copy%22);%0Abtn.textContent = %22%5Cu2705 Copied!%22;%0AsetTimeout(function() { btn.textContent = %22Copy log%22; }, 2000);%0A} catch (e) {%0Abtn.textContent = %22Copy failed%22;%0AsetTimeout(function() { btn.textContent = %22Copy log%22; }, 2000);%0A}%0Adocument.body.removeChild(ta);%0A}%0Alog(%22Ready. Click a button to start exporting.%22);%0A})();"
           onclick="event.preventDefault();alert('Don\'t click — drag this button up to your bookmark bar!');">
          📦 GPT→Claude Export
        </a>
        <p class="drag-hint"><strong>Drag</strong> the button above to your bookmark bar.<br>No bookmark bar? Press <strong>Ctrl+Shift+B</strong></p>
      </div>
      <div class="install-steps">
        <div class="install-step"><div class="install-step-num">1</div><p>Drag the gold button above into your <strong>bookmark bar</strong></p></div>
        <div class="install-step"><div class="install-step-num">2</div><p>Go to <a href="https://chatgpt.com" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600;">chatgpt.com</a> and make sure you're logged in</p></div>
        <div class="install-step"><div class="install-step-num">3</div><p>Click the <strong>GPT→Claude Export</strong> bookmark — a panel appears on the page</p></div>
        <div class="install-step"><div class="install-step-num">4</div><p>Click the export buttons. Files download to your computer automatically.</p></div>
      </div>
    </div>

    <!-- FIREFOX TAB -->
    <div class="tab-content" id="tab-firefox">
      <div class="install-steps">
        <div class="install-step"><div class="install-step-num">1</div>
          <div>
            <p>Right-click your <strong>bookmark bar</strong> → click <strong>"Add Bookmark..."</strong></p>
            <p style="font-size:0.8rem; color:#555; margin-top:0.25rem;">No bookmark bar? Press Ctrl+Shift+B to show it</p>
          </div>
        </div>
        <div class="install-step"><div class="install-step-num">2</div>
          <div>
            <p>Set the <strong>Name</strong> to: <strong style="color:var(--accent);">GPT→Claude Export</strong></p>
          </div>
        </div>
        <div class="install-step"><div class="install-step-num">3</div>
          <div>
            <p>Click the button below to copy the bookmark URL:</p>
            <button class="action-btn" id="copy-bookmark-url" style="margin-top:0.5rem;">📋 Copy bookmark URL</button>
            <p class="copy-confirm" id="copy-url-confirm">✅ Copied! Now paste it into the URL field.</p>
          </div>
        </div>
        <div class="install-step"><div class="install-step-num">4</div>
          <div>
            <p>Paste (<strong>Ctrl+V</strong>) into the <strong>Location (URL)</strong> field → click <strong>Save</strong></p>
          </div>
        </div>
        <div class="install-step"><div class="install-step-num">5</div>
          <div>
            <p>Go to <a href="https://chatgpt.com" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600;">chatgpt.com</a>, log in, click your new bookmark. The export panel appears!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ANY BROWSER / PASTE TAB -->
    <div class="tab-content" id="tab-paste">
      <div class="install-steps">
        <div class="install-step"><div class="install-step-num">1</div><p>Go to <a href="https://chatgpt.com" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600;">chatgpt.com</a> and log in</p></div>
        <div class="install-step"><div class="install-step-num">2</div><p>Press <strong>F12</strong> on your keyboard → click the <strong>Console</strong> tab</p></div>
        <div class="install-step"><div class="install-step-num">3</div>
          <div>
            <p>Click the button below to copy the export script:</p>
            <button class="action-btn" id="copy-full-script" style="margin-top:0.5rem;">📋 Copy export script</button>
            <p class="copy-confirm" id="copy-script-confirm">✅ Copied! Now paste into the console.</p>
          </div>
        </div>
        <div class="install-step"><div class="install-step-num">4</div><p>Click inside the console, press <strong>Ctrl+V</strong> to paste, then press <strong>Enter</strong></p></div>
        <div class="install-step"><div class="install-step-num">5</div><p>The export panel appears on the ChatGPT page. Click the buttons to export.</p></div>
      </div>
      <p style="font-size:0.8rem; color:#555; margin-top:1rem;">Firefox users: if you see a warning about pasting, type <strong>allow pasting</strong> and press Enter first.</p>
    </div>
  </div>

  <!-- ========== HOW TO USE ========== -->
  <div class="steps">
    <h2>What happens when you run it</h2>
    <div class="step-list">
      <div class="step-item">
        <div class="step-num s1">1</div>
        <div class="step-text"><h3>A floating panel appears</h3><p>Dark panel on the right side of the ChatGPT page with three export buttons. You can drag it around.</p></div>
      </div>
      <div class="step-item">
        <div class="step-num s2">2</div>
        <div class="step-text"><h3>Click each button to export</h3><p>Memories, conversations, and instructions. Each one downloads a file automatically. Conversations show a progress bar.</p></div>
      </div>
      <div class="step-item">
        <div class="step-num s3">3</div>
        <div class="step-text"><h3>Upload to Claude</h3><p>Go to <a href="https://claude.ai" style="color:var(--accent)">claude.ai</a> (or the desktop app: <strong>+</strong> → <strong>Add files</strong>) and upload the downloaded files.</p></div>
      </div>
    </div>
  </div>

  <!-- ========== WHAT YOU GET ========== -->
  <div class="exports-section">
    <h2>What you get</h2>
    <div class="export-grid">
      <div class="export-card">
        <div class="icon">🧠</div>
        <h3>Memories</h3>
        <p>Every fact ChatGPT memorized about you.</p>
        <span class="filename">chatgpt_memories.md</span>
      </div>
      <div class="export-card">
        <div class="icon">💬</div>
        <h3>Conversations</h3>
        <p>Every chat with full history, timestamps, model info.</p>
        <span class="filename">chatgpt_all_conversations.json</span>
      </div>
      <div class="export-card">
        <div class="icon">⚙️</div>
        <h3>Instructions</h3>
        <p>Custom instructions and settings.</p>
        <span class="filename">chatgpt_instructions.json</span>
      </div>
    </div>
  </div>

  <!-- ========== IMPORTING TO CLAUDE ========== -->
  <div class="exports-section" id="importing">
    <h2>Importing to Claude</h2>
    <div class="step-list">
      <div class="step-item">
        <div class="step-num s1">1</div>
        <div class="step-text">
          <h3>Upload memories first</h3>
          <p>Upload <strong>chatgpt_memories.md</strong> with this prompt:</p>
          <p style="color:var(--accent); margin-top:0.5rem; font-style:italic;">"I just migrated from ChatGPT. This file contains all the facts and memories ChatGPT had stored about me. Please read through every item carefully and remember all of these facts about me. Confirm what you've learned and note if anything seems contradictory or outdated."</p>
        </div>
      </div>
      <div class="step-item">
        <div class="step-num s2">2</div>
        <div class="step-text">
          <h3>Upload conversations</h3>
          <p>Upload <strong>chatgpt_all_conversations.json</strong> (zip it if large) with this prompt:</p>
          <p style="color:var(--accent); margin-top:0.5rem; font-style:italic;">"This is my complete ChatGPT conversation history. Please analyze it and create a structured summary: (1) Key ongoing projects, (2) Important decisions, (3) Personal context and preferences, (4) Anything unfinished I should pick up."</p>
        </div>
      </div>
      <div class="step-item">
        <div class="step-num s3">3</div>
        <div class="step-text">
          <h3>Upload instructions</h3>
          <p>Upload <strong>chatgpt_instructions.json</strong> with this prompt:</p>
          <p style="color:var(--accent); margin-top:0.5rem; font-style:italic;">"These are my custom instructions from ChatGPT. Please adapt your communication style to match my preferences."</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== WHAT TO EXPECT ========== -->
  <div class="exports-section" id="expectations">
    <h2>What to expect after migrating</h2>
    <div class="fallback-box">
      <h3>Claude remembers the facts, but needs time to know <em>you</em></h3>
      <p>Think of it like switching doctors. The new doctor has your complete file but doesn't <em>know</em> you yet. Claude gets roughly <strong>70%</strong> from the import. The rest — your humor, style, priorities — builds naturally over a couple of weeks.</p>
      <p style="margin-bottom:0;"><strong>The upside:</strong> Claude calibrates to who you are <em>now</em>, not who you were two years ago.</p>
    </div>
    <div class="fallback-box">
      <h3>Example conversations after import</h3>
      <p style="color:var(--text);"><strong>You:</strong> "Remember that sourdough recipe we worked on?"</p>
      <p style="color:var(--accent)"><strong>Claude:</strong> "Yes — 78% hydration, overnight cold proof. You said the crust was perfect but crumb too dense. We were going to try autolyse. Want to tweak it?"</p>
      <p style="color:var(--text); margin-top:0.75rem;"><strong>You:</strong> "What was that movie you recommended?"</p>
      <p style="color:var(--accent); margin-bottom:0;"><strong>Claude:</strong> "You asked for sci-fi that doesn't treat the audience like idiots. I suggested Arrival, Primer, and Coherence. You watched Primer and said it melted your brain."</p>
    </div>
  </div>

  <!-- ========== FAQ ========== -->
  <div class="faq">
    <h2>Common questions</h2>
    <div class="faq-item"><h3>How do I read the exported JSON?</h3><p>Open the <a href="viewer.html" style="color:var(--accent);text-decoration:none;font-weight:600;">Conversation Viewer</a> in your browser and drag your file into it. You can browse, sort, and search all your conversations in a chat-like format. Or upload the file to Claude and ask it to find what you're looking for.</p></div>
    <div class="faq-item"><h3>Is this safe?</h3><p>Everything runs in your browser. No data is sent anywhere. Files save directly to your computer. Source code is open on GitHub.</p></div>
    <div class="faq-item"><h3>How long does the conversation export take?</h3><p>~1 second per conversation. 500 chats ≈ 10 minutes. Don't close the tab.</p></div>
    <div class="faq-item"><h3>Works with free ChatGPT?</h3><p>Yes. Free, Plus, Team, Enterprise — all work.</p></div>
    <div class="faq-item"><h3>File too large for Claude?</h3><p>Zip it first. Right-click → Compress. Claude accepts .zip uploads.</p></div>
    <div class="faq-item"><h3>Export stopped or errored?</h3><p>Usually a rate limit. Wait a minute, refresh <a href="https://chatgpt.com" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;font-weight:700;">chatgpt.com</a>, try again. The tool retries automatically.</p></div>
    <div class="faq-item"><h3>Will OpenAI ban me?</h3><p>You're accessing your own data through your own login session, using the same API the website uses. That said, these are undocumented endpoints.</p></div>
    <div class="faq-item"><h3>Why not just use a browser extension?</h3><p>Extensions export conversations as text. This tool exports <strong>memory items</strong>, message metadata, timestamps, model info, and custom instructions — everything needed for a real migration.</p></div>
  </div>

  <!-- ========== FOOTER ========== -->
  <div class="footer">
    <p>GPT→Claude Migration Kit — built with <a href="https://claude.ai">Claude</a> by <a href="https://www.siamsnus.com">Siamsnus</a></p>
    <p>Open source under MIT License — <a href="https://github.com/Siamsnus/GPT2Claude-Migration-Kit">View source on GitHub</a></p>
    <p style="margin-top:0.75rem; font-size:0.72rem; color:#444;">OpenAI's internal API may change without notice. Not affiliated with OpenAI or Anthropic.</p>
  </div>
</div>

<!-- Full script stored here for copy button -->
<script id="migrate-source" type="text/plain">
// GPT2Claude Migration Kit v2.3
// https://github.com/Siamsnus/GPT2Claude-Migration-Kit
// Exports ChatGPT memories, conversations, and instructions
// No data leaves your browser - everything runs locally

(function() {
  // Prevent double-loading
  if (document.getElementById("gpt2claude-panel")) {
    var existing = document.getElementById("gpt2claude-panel");
    existing.style.animation = "g2c-shake 0.3s ease-in-out";
    setTimeout(function() { existing.style.animation = ""; }, 300);
    return;
  }

  // ========== STYLES ==========
  var style = document.createElement("style");
  style.textContent = "\
    @keyframes g2c-fadein { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }\
    @keyframes g2c-shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }\
    @keyframes g2c-spin { to { transform: rotate(360deg); } }\
    @keyframes g2c-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }\
    @keyframes g2c-indeterminate { 0% { left: -30%; width: 30%; } 50% { left: 50%; width: 30%; } 100% { left: 100%; width: 30%; } }\
    @keyframes g2c-pulse-count { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }\
    @keyframes g2c-dot-bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-4px); } }\
    .g2c-progress-fill.indeterminate { position: relative; width: 100% !important; background: none !important; overflow: hidden; }\
    .g2c-progress-fill.indeterminate::after { content: ''; position: absolute; top: 0; left: -30%; width: 30%; height: 100%; background: linear-gradient(90deg, transparent, #d4a574, transparent); border-radius: 3px; animation: g2c-indeterminate 1.5s ease-in-out infinite; }\
    .g2c-scan-hero { text-align: center; padding: 20px 0 10px; }\
    .g2c-scan-hero .g2c-scan-count { font-size: 42px; font-weight: 800; color: #d4a574; font-variant-numeric: tabular-nums; animation: g2c-pulse-count 2s ease-in-out infinite; line-height: 1; }\
    .g2c-scan-hero .g2c-scan-label { font-size: 12px; color: #888; margin-top: 4px; }\
    .g2c-scan-hero .g2c-scan-status { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 12px; font-size: 12px; color: #999; }\
    .g2c-scan-dots { display: flex; gap: 3px; }\
    .g2c-scan-dots span { width: 4px; height: 4px; background: #d4a574; border-radius: 50%; animation: g2c-dot-bounce 1.2s ease-in-out infinite; }\
    .g2c-scan-dots span:nth-child(2) { animation-delay: 0.15s; }\
    .g2c-scan-dots span:nth-child(3) { animation-delay: 0.3s; }\
    .g2c-scan-models { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 14px; padding-top: 14px; border-top: 1px solid #2a2a35; }\
    .g2c-scan-tag { font-size: 10px; padding: 3px 10px; background: #1e1e26; border: 1px solid #2a2a35; border-radius: 20px; color: #a0a0e0; font-family: 'SF Mono', Consolas, monospace; }\
    .g2c-scan-reassure { font-size: 11px; color: #555; text-align: center; margin-top: 12px; }\
    .g2c-dl-hero { text-align: center; padding: 16px 0 8px; }\
    .g2c-dl-hero .g2c-dl-count { font-size: 28px; font-weight: 700; color: #7eb8a0; }\
    .g2c-dl-hero .g2c-dl-of { font-size: 14px; color: #555; }\
    .g2c-dl-hero .g2c-dl-title { font-size: 11px; color: #888; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px; }\
    .g2c-dl-pct { font-size: 11px; color: #d4a574; font-family: 'SF Mono', Consolas, monospace; text-align: right; margin-top: 6px; }\
    .g2c-dl-remaining { font-size: 11px; color: #666; text-align: center; margin-top: 8px; }\
    .g2c-complete { text-align: center; padding: 20px 0 10px; }\
    .g2c-complete-icon { font-size: 36px; margin-bottom: 6px; }\
    .g2c-complete-title { font-size: 18px; font-weight: 700; color: #7eb8a0; }\
    .g2c-complete-sub { font-size: 12px; color: #888; margin-top: 6px; }\
    .g2c-complete-models { font-size: 11px; color: #d4a574; margin-top: 6px; font-family: 'SF Mono', Consolas, monospace; }\
.g2c-complete-models-wrap { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 12px; }\
.g2c-models-extra { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; width: 100%; margin-top: 4px; }\
.g2c-models-toggle { font-size: 10px; padding: 3px 10px; background: none; border: 1px dashed #333340; border-radius: 20px; color: #888; cursor: pointer; font-family: 'SF Mono', Consolas, monospace; }\
.g2c-models-toggle:hover { border-color: #d4a574; color: #d4a574; }\
    .g2c-whatsnext { margin: 16px 0; padding: 14px; background: #141418; border: 1px solid #252530; border-radius: 10px; }\
    .g2c-whatsnext-title { font-size: 11px; color: #888; margin-bottom: 10px; font-weight: 600; }\
    .g2c-whatsnext-item { font-size: 12px; color: #ccc; line-height: 1.8; margin-bottom: 10px; }\
    .g2c-whatsnext-item:last-child { margin-bottom: 0; }\
    .g2c-whatsnext-item a { color: #d4a574; text-decoration: none; }\
    .g2c-whatsnext-item a:hover { text-decoration: underline; }\
    .g2c-whatsnext-badge { font-size: 10px; color: #7eb8a0; background: rgba(126,184,160,0.12); padding: 1px 6px; border-radius: 4px; }\
    .g2c-copy-log { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; padding: 6px 0; margin-top: 10px; margin-left: 12px; }\
    .g2c-copy-log:hover { color: #aaa; }\
    #gpt2claude-panel { position: fixed; top: 50%; right: 24px; transform: translateY(-50%); width: 360px; background: #1a1a1f; border: 1px solid #333340; border-radius: 16px; box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.06); z-index: 999999; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #e8e8ec; animation: g2c-fadein 0.3s ease-out; }\
    #gpt2claude-panel * { box-sizing: border-box; margin: 0; padding: 0; }\
    .g2c-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 22px 14px; border-bottom: 1px solid #2a2a35; background: #1e1e24; border-radius: 16px 16px 0 0; }\
    .g2c-title { font-size: 15px; font-weight: 700; letter-spacing: -0.01em; }\
    .g2c-title span.gpt { color: #a0a0e0; }\
    .g2c-title span.arrow { color: #555; margin: 0 4px; }\
    .g2c-title span.claude { color: #d4a574; }\
    .g2c-version { font-size: 10px; color: #666; font-weight: 600; margin-top: 2px; }\
    .g2c-close { background: none; border: none; color: #777; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; line-height: 1; }\
    .g2c-close:hover { background: #252530; color: #e8e8ec; }\
    .g2c-body { padding: 18px 22px 14px; }\
    .g2c-btn { width: 100%; padding: 14px 16px; border: 1px solid #333340; border-radius: 12px; background: #222228; color: #e8e8ec; font-size: 13px; font-weight: 600; cursor: pointer; text-align: left; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; transition: all 0.15s ease; position: relative; overflow: hidden; }\
    .g2c-btn:hover { background: #2a2a32; border-color: #444450; transform: translateY(-1px); }\
    .g2c-btn:active { transform: translateY(0); }\
    .g2c-btn.running { pointer-events: none; border-color: #d4a574; }\
    .g2c-btn.done { border-color: #7eb8a0; }\
    .g2c-btn.error { border-color: #e07070; }\
    .g2c-btn-icon { font-size: 20px; width: 28px; text-align: center; flex-shrink: 0; }\
    .g2c-btn-text { flex: 1; }\
    .g2c-btn-sub { font-size: 11px; color: #777; font-weight: 400; margin-top: 3px; }\
    .g2c-progress { margin-top: 10px; }\
    .g2c-progress-bar { width: 100%; height: 5px; background: #252530; border-radius: 3px; overflow: hidden; }\
    .g2c-progress-fill { height: 100%; background: linear-gradient(90deg, #d4a574, #e8c49a); border-radius: 3px; transition: width 0.3s ease; width: 0%; }\
    .g2c-progress-text { font-size: 11px; color: #999; margin-top: 6px; }\
    .g2c-log { margin-top: 14px; max-height: 140px; overflow-y: auto; background: #141418; border: 1px solid #252530; border-radius: 10px; padding: 10px 12px; font-family: 'SF Mono', 'Consolas', monospace; font-size: 11px; line-height: 1.6; color: #999; display: none; }\
    .g2c-log.visible { display: block; }\
    .g2c-log-entry { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\
    .g2c-log-entry.error { color: #e07070; }\
    .g2c-log-entry.success { color: #7eb8a0; }\
    .g2c-footer { padding: 14px 22px; border-top: 1px solid #252530; display: flex; justify-content: space-between; align-items: center; }\
    .g2c-footer-text { font-size: 10px; color: #555; }\
    .g2c-footer-link { font-size: 10px; color: #d4a574; text-decoration: none; }\
    .g2c-footer-link:hover { text-decoration: underline; }\
    .g2c-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #444; border-top-color: #d4a574; border-radius: 50%; animation: g2c-spin 0.6s linear infinite; }\
    .g2c-toggle-log { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; padding: 6px 0; margin-top: 10px; }\
    .g2c-toggle-log:hover { color: #aaa; }\
    .g2c-drag-handle { cursor: move; }\
    .g2c-divider { height: 1px; background: #2a2a35; margin: 6px 0 10px; }\
    .g2c-filter-panel { margin-top: 10px; }\
    .g2c-filter-section { margin-bottom: 12px; }\
    .g2c-filter-label { font-size: 10px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }\
    .g2c-filter-models { max-height: 120px; overflow-y: auto; background: #141418; border: 1px solid #252530; border-radius: 8px; padding: 6px 8px; }\
    .g2c-model-row { display: flex; align-items: center; padding: 3px 0; font-size: 12px; cursor: pointer; color: #ccc; }\
    .g2c-model-row:hover { color: #fff; }\
    .g2c-model-row input { margin-right: 8px; accent-color: #d4a574; }\
    .g2c-model-row .cnt { color: #666; margin-left: auto; font-size: 10px; font-family: monospace; }\
    .g2c-filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }\
    .g2c-filter-input { flex: 1; padding: 6px 8px; background: #141418; border: 1px solid #252530; border-radius: 6px; color: #e8e8ec; font-size: 12px; font-family: monospace; outline: none; }\
    .g2c-filter-input:focus { border-color: #d4a574; }\
    .g2c-filter-input::placeholder { color: #555; }\
    .g2c-filter-summary { font-size: 12px; color: #d4a574; padding: 8px 0; font-weight: 600; }\
    .g2c-filter-drop { border: 1px dashed #333340; border-radius: 8px; padding: 10px; text-align: center; font-size: 11px; color: #666; cursor: pointer; transition: all 0.15s; }\
    .g2c-filter-drop:hover { border-color: #d4a574; color: #999; }\
    .g2c-filter-drop.active { border-color: #7eb8a0; color: #7eb8a0; }\
    .g2c-select-btns { display: flex; gap: 6px; margin-top: 4px; }\
    .g2c-select-btns button { background: none; border: none; color: #666; font-size: 10px; cursor: pointer; padding: 0; }\
    .g2c-select-btns button:hover { color: #d4a574; }\
  ";
  document.head.appendChild(style);

  // ========== PANEL HTML ==========
  var panel = document.createElement("div");
  panel.id = "gpt2claude-panel";
  panel.innerHTML = '\
    <div class="g2c-header g2c-drag-handle">\
      <div>\
        <div class="g2c-title"><span class="gpt">GPT</span><span class="arrow">\u2192</span><span class="claude">Claude</span></div>\
        <div class="g2c-version">Migration Kit v2.3</div>\
      </div>\
      <button class="g2c-close" id="g2c-close">\u00D7</button>\
    </div>\
    <div class="g2c-body">\
      <button class="g2c-btn" id="g2c-btn-memory">\
        <div class="g2c-btn-icon">\uD83E\uDDE0</div>\
        <div class="g2c-btn-text">\
          Export Memories\
          <div class="g2c-btn-sub">Facts ChatGPT learned about you</div>\
        </div>\
      </button>\
      <button class="g2c-btn" id="g2c-btn-convos">\
        <div class="g2c-btn-icon">\uD83D\uDCAC</div>\
        <div class="g2c-btn-text">\
          Export All Conversations\
          <div class="g2c-btn-sub">Scans first, then you choose what to download</div>\
        </div>\
      </button>\
      <button class="g2c-btn" id="g2c-btn-instructions">\
        <div class="g2c-btn-icon">\u2699\uFE0F</div>\
        <div class="g2c-btn-text">\
          Export Instructions\
          <div class="g2c-btn-sub">Custom instructions &amp; settings</div>\
        </div>\
      </button>\
      <button class="g2c-btn" id="g2c-btn-all" style="border-color:#d4a574;background:#222228;">\
        <div class="g2c-btn-icon">\uD83D\uDCE5</div>\
        <div class="g2c-btn-text">\
          <span style="color:#d4a574;">Export Everything</span>\
          <div class="g2c-btn-sub">All three in one click</div>\
        </div>\
      </button>\
      <div class="g2c-progress" id="g2c-progress" style="display:none;">\
        <div class="g2c-progress-bar"><div class="g2c-progress-fill" id="g2c-progress-fill"></div></div>\
        <div class="g2c-progress-text" id="g2c-progress-text"></div>\
      </div>\
      <button class="g2c-toggle-log" id="g2c-toggle-log">Show log \u25BC</button>\
      <button class="g2c-copy-log" id="g2c-copy-log">Copy log</button>\
      <div class="g2c-log" id="g2c-log"></div>\
    </div>\
    <div class="g2c-footer">\
      <span class="g2c-footer-text">All data stays in your browser</span>\
      <a class="g2c-footer-link" href="https://github.com/Siamsnus/GPT2Claude-Migration-Kit" target="_blank">GitHub</a>\
    </div>\
  ';
  document.body.appendChild(panel);

  // ========== DRAGGING ==========
  var isDragging = false;
  var dragOffsetX = 0;
  var dragOffsetY = 0;
  var header = panel.querySelector(".g2c-drag-handle");

  header.addEventListener("mousedown", function(e) {
    if (e.target.classList.contains("g2c-close")) return;
    isDragging = true;
    var rect = panel.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    panel.style.transition = "none";
    e.preventDefault();
  });

  document.addEventListener("mousemove", function(e) {
    if (!isDragging) return;
    panel.style.right = "auto";
    panel.style.transform = "none";
    panel.style.left = (e.clientX - dragOffsetX) + "px";
    panel.style.top = (e.clientY - dragOffsetY) + "px";
  });

  document.addEventListener("mouseup", function() {
    isDragging = false;
    panel.style.transition = "";
  });

  // ========== HELPERS ==========
  var logEl = document.getElementById("g2c-log");
  var progressEl = document.getElementById("g2c-progress");
  var progressFill = document.getElementById("g2c-progress-fill");
  var progressText = document.getElementById("g2c-progress-text");

  function log(msg, type) {
    var entry = document.createElement("div");
    entry.className = "g2c-log-entry" + (type ? " " + type : "");
    entry.textContent = msg;
    logEl.appendChild(entry);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setProgress(pct, text) {
    progressEl.style.display = "block";
    progressFill.style.width = pct + "%";
    if (text) progressText.textContent = text;
  }

  function setButtonState(btn, state, label) {
    btn.className = "g2c-btn " + state;
    var iconEl = btn.querySelector(".g2c-btn-icon");
    if (state === "running") {
      iconEl.innerHTML = '<div class="g2c-spinner"></div>';
    } else if (state === "done") {
      iconEl.textContent = "\u2705";
    } else if (state === "error") {
      iconEl.textContent = "\u274C";
    }
    if (label) {
      btn.querySelector(".g2c-btn-sub").textContent = label;
    }
  }

  function downloadFile(content, filename, type) {
    var blob = new Blob([content], {type: type || "text/plain"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log("Downloaded: " + filename, "success");
  }

  // Safe event listener helper — guards against null elements in ChatGPT's SPA
  function safeAddEvent(id, event, handler) {
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener(event, handler);
    } else {
      log("Warning: element #" + id + " not found", "error");
    }
    return el;
  }

  var cachedToken = null;

  async function getToken() {
    if (cachedToken) return cachedToken;
    log("Authenticating...");
    var resp = await fetch("https://chatgpt.com/api/auth/session", {credentials: "include"});
    if (resp.status !== 200) {
      throw new Error("Auth failed (HTTP " + resp.status + "). Are you logged in?");
    }
    var data = await resp.json();
    if (!data.accessToken) {
      throw new Error("No token found. Please refresh chatgpt.com and try again.");
    }
    cachedToken = data.accessToken;
    log("Authenticated OK");
    return cachedToken;
  }

  // Extract model from conversation metadata — tries multiple field names
  function getConvoModel(c) {
    return c.default_model_slug || c.model || c.model_slug || c.gpt_model || "unknown";
  }

  // Extract timestamp from conversation — handles epoch (seconds or ms) and ISO strings
  function getConvoTime(c) {
    var raw = c.update_time || c.updated_at || c.create_time || c.created_at || 0;
    if (!raw) return 0;
    if (typeof raw === "string") {
      // ISO date string
      var parsed = new Date(raw).getTime() / 1000;
      return isNaN(parsed) ? 0 : parsed;
    }
    // Epoch: if > 1e12 it's milliseconds, convert to seconds
    if (raw > 1e12) return raw / 1000;
    return raw;
  }

  // ========== EXPORT: MEMORIES ==========
  async function exportMemories() {
    var btn = document.getElementById("g2c-btn-memory");
    setButtonState(btn, "running", "Exporting...");

    try {
      var token = await getToken();

      log("Fetching memories...");
      var resp = await fetch("https://chatgpt.com/backend-api/memories", {
        credentials: "include",
        headers: {"Authorization": "Bearer " + token}
      });

      if (resp.status !== 200) {
        throw new Error("Could not fetch memories (HTTP " + resp.status + ")");
      }

      var data = await resp.json();
      var memories = data.memories || data.results || data;
      var md = "# ChatGPT Memory Export\n";
      md += "# Exported: " + new Date().toISOString() + "\n";
      md += "# Tool: GPT2Claude Migration Kit v2.3\n\n";

      var count = 0;
      if (Array.isArray(memories)) {
        count = memories.length;
        for (var i = 0; i < memories.length; i++) {
          var m = memories[i];
          var content = m.content || m.value || m.text || m.memory || JSON.stringify(m);
          md += (i + 1) + ". " + content + "\n";
        }
      } else {
        md += JSON.stringify(memories, null, 2);
      }

      log("Found " + count + " memories");
      downloadFile(md, "chatgpt_memories.md", "text/markdown");
      setButtonState(btn, "done", count + " memories exported");

    } catch (err) {
      log("Memory export failed: " + err.message, "error");
      setButtonState(btn, "error", err.message);
    }
  }

  // ========== EXPORT: CONVERSATIONS ==========
  var scannedConvos = [];
  var previousExportIds = {};
  var BATCH_SIZE = 10;

  async function exportConversations() {
    var btn = document.getElementById("g2c-btn-convos");
    setButtonState(btn, "running", "Scanning...");

    // Show indeterminate progress
    var progressEl = document.getElementById("g2c-progress");
    progressEl.style.display = "block";
    var fillEl = document.getElementById("g2c-progress-fill");
    fillEl.classList.add("indeterminate");
    fillEl.style.width = "100%";

    // Insert scan hero display (State 2)
    var scanHero = document.createElement("div");
    scanHero.className = "g2c-scan-hero";
    scanHero.id = "g2c-scan-hero";
    scanHero.innerHTML = '<div class="g2c-scan-count" id="g2c-scan-count">0</div>' +
      '<div class="g2c-scan-label">conversations found</div>' +
      '<div class="g2c-scan-status" id="g2c-scan-status">' +
        '<span class="g2c-scan-dots"><span></span><span></span><span></span></span>' +
        ' Scanning your conversations\u2026' +
      '</div>' +
      '<div class="g2c-scan-models" id="g2c-scan-models"></div>' +
      '<div class="g2c-scan-reassure">Filter options appear when scan completes</div>';
    progressEl.parentNode.insertBefore(scanHero, progressEl.nextSibling);

    try {
      var token = await getToken();
      var headers = {"Authorization": "Bearer " + token};
      scannedConvos = [];
      var offset = 0;
      var liveModels = {};
      var scanLimit = 100;

      log("Scanning conversation list...");

      while (true) {
        var listResp = await fetch(
          "https://chatgpt.com/backend-api/conversations?offset=" + offset + "&limit=" + scanLimit + "&order=updated",
          {credentials: "include", headers: headers}
        );

        if (listResp.status !== 200) {
          throw new Error("Could not get conversations (HTTP " + listResp.status + ")");
        }

        var listData = await listResp.json();
        var items = listData.items || [];
        log("Batch: " + items.length + " conversations (offset " + offset + ")");

        // Log first item's keys for diagnostics
        if (offset === 0 && items.length > 0) {
          var sampleKeys = Object.keys(items[0]).join(", ");
          log("API fields: " + sampleKeys);
          var sample = items[0];
          log("Sample model: " + (sample.default_model_slug || sample.model || sample.model_slug || "null"));
          log("Sample time: update=" + sample.update_time + " create=" + sample.create_time);
          log("Sample gizmo: " + (sample.gizmo_id || sample.conversation_template_id || sample.workspace_id || "none"));
        }

        for (var j = 0; j < items.length; j++) {
          scannedConvos.push(items[j]);
          var m = getConvoModel(items[j]);
          liveModels[m] = (liveModels[m] || 0) + 1;
        }

        // Update scan hero display
        var countEl = document.getElementById("g2c-scan-count");
        var statusEl = document.getElementById("g2c-scan-status");
        if (countEl) countEl.textContent = scannedConvos.length.toLocaleString();
        if (statusEl) {
          statusEl.innerHTML = items.length >= scanLimit
            ? '<span class="g2c-scan-dots"><span></span><span></span><span></span></span> Still scanning \u2014 this takes a minute, all good'
            : 'Scan complete!';
        }

        // Update model tags
        var tagsHtml = "";
        var modelKeys = Object.keys(liveModels).sort(function(a, b) { return liveModels[b] - liveModels[a]; });
        for (var mi = 0; mi < modelKeys.length; mi++) {
          tagsHtml += '<span class="g2c-scan-tag">' + modelKeys[mi] + ' (' + liveModels[modelKeys[mi]] + ')</span>';
        }
        var modelsEl = document.getElementById("g2c-scan-models");
        if (modelsEl) modelsEl.innerHTML = tagsHtml;

        offset += items.length;
        if (items.length < scanLimit) break;
        await new Promise(function(r) { setTimeout(r, 500); });
      }

      log("Total conversations: " + scannedConvos.length);

      // Discover and fetch project conversations via sidebar DOM scraping
      try {
        log("Checking for projects...");
        var statusEl = document.getElementById("g2c-scan-status");
        if (statusEl) statusEl.innerHTML = '<span class="g2c-scan-dots"><span></span><span></span><span></span></span> Checking projects\u2026';

        var discoveredProjects = {};

        // Method 1: Check conversation items for gizmo_id (project conversations have this)
        for (var gi = 0; gi < scannedConvos.length; gi++) {
          var gid = scannedConvos[gi].gizmo_id || scannedConvos[gi].conversation_template_id || scannedConvos[gi].workspace_id || null;
          if (gid && gid.indexOf("g-p-") === 0 && !discoveredProjects[gid]) {
            discoveredProjects[gid] = null; // name unknown yet
            log("Found project gizmo in conversation list: " + gid);
          }
        }

        // Method 2: Try API endpoint for user's gizmos/projects
        try {
          var gizmoResp = await fetch(
            "https://chatgpt.com/backend-api/gizmos/discovery/mine",
            {credentials: "include", headers: headers}
          );
          if (gizmoResp.status === 200) {
            var gizmoData = await gizmoResp.json();
            var gizmoItems = gizmoData.list || gizmoData.items || gizmoData.gizmos || [];
            if (Array.isArray(gizmoItems)) {
              for (var gmi = 0; gmi < gizmoItems.length; gmi++) {
                var gizmo = gizmoItems[gmi].resource || gizmoItems[gmi].gizmo || gizmoItems[gmi];
                var gizmoId = gizmo.id || gizmo.short_url || "";
                if (gizmoId.indexOf("g-p-") === 0 || (gizmo.type && gizmo.type === "project")) {
                  var gName = (gizmo.display && gizmo.display.name) || gizmo.name || gizmo.title || "Project";
                  discoveredProjects[gizmoId] = gName;
                  log("Found project via API: " + gName + " (" + gizmoId + ")");
                }
              }
            }
          } else {
            log("Gizmos API: HTTP " + gizmoResp.status + " (trying other methods)");
          }
        } catch (apiErr) {
          log("Gizmos API failed: " + apiErr.message + " (trying other methods)");
        }

        // Method 3: DOM scraping fallback — scan sidebar for project links
        var projLinks = document.querySelectorAll('a[href*="/g/g-p-"]');
        for (var pl = 0; pl < projLinks.length; pl++) {
          var href = projLinks[pl].getAttribute("href") || "";
          var idMatch = href.match(/g-p-[a-f0-9]+/);
          if (!idMatch) continue;
          var projId = idMatch[0];
          if (discoveredProjects[projId]) continue;
          var slugMatch = href.match(/g-p-[a-f0-9]+-([^/]+)/);
          var linkText = projLinks[pl].textContent.trim();
          var projName = linkText || (slugMatch ? slugMatch[1].replace(/-/g, " ") : "Project");
          if (href.indexOf("/c/") > -1) continue;
          discoveredProjects[projId] = projName;
          log("Found project via DOM: " + projName + " (" + projId + ")");
        }

        var projIds = Object.keys(discoveredProjects);
        if (projIds.length > 0) {
          log("Found " + projIds.length + " project(s) total");

          // Build index of existing conversation IDs for deduplication
          var existingIdx = {};
          for (var ei = 0; ei < scannedConvos.length; ei++) {
            existingIdx[scannedConvos[ei].id] = ei;
          }

          for (var pi = 0; pi < projIds.length; pi++) {
            var projId = projIds[pi];
            var projName = discoveredProjects[projId] || "Project";

            // Try to resolve project name if unknown
            if (projName === "Project" || projName === null) {
              try {
                var infoResp = await fetch(
                  "https://chatgpt.com/backend-api/gizmos/" + projId,
                  {credentials: "include", headers: headers}
                );
                if (infoResp.status === 200) {
                  var infoData = await infoResp.json();
                  var gizmoInfo = infoData.gizmo || infoData;
                  projName = (gizmoInfo.display && gizmoInfo.display.name) || gizmoInfo.name || gizmoInfo.title || "Project";
                  log("Resolved project name: " + projName);
                }
              } catch (nameErr) {
                // keep default name
              }
            }

            log("Fetching project: " + projName + " (" + projId + ")");
            var statusEl = document.getElementById("g2c-scan-status");
            if (statusEl) statusEl.innerHTML = '<span class="g2c-scan-dots"><span></span><span></span><span></span></span> Scanning project: ' + projName + '\u2026';

            var cursor = 0;
            var projConvoCount = 0;
            var projTaggedCount = 0;
            while (true) {
              var projConvoResp = await fetch(
                "https://chatgpt.com/backend-api/gizmos/" + projId + "/conversations?cursor=" + cursor,
                {credentials: "include", headers: headers}
              );
              if (projConvoResp.status !== 200) {
                log("Project " + projName + ": HTTP " + projConvoResp.status, "error");
                break;
              }
              var projConvoData = await projConvoResp.json();
              var projItems = projConvoData.items || [];
              for (var pj = 0; pj < projItems.length; pj++) {
                projItems[pj]._project = projName;
                projItems[pj]._project_id = projId;
                // Only add if not already in main scan (deduplicate)
                if (existingIdx[projItems[pj].id] === undefined) {
                  scannedConvos.push(projItems[pj]);
                  existingIdx[projItems[pj].id] = scannedConvos.length - 1;
                  projConvoCount++;
                } else {
                  // Tag the existing entry as belonging to this project
                  var dupIdx = existingIdx[projItems[pj].id];
                  scannedConvos[dupIdx]._project = projName;
                  scannedConvos[dupIdx]._project_id = projId;
                  projTaggedCount++;
                }
              }
              var countEl = document.getElementById("g2c-scan-count");
              if (countEl) countEl.textContent = scannedConvos.length.toLocaleString();

              // Cursor-based pagination: null cursor means no more pages
              if (projConvoData.cursor === null || projConvoData.cursor === undefined || projItems.length === 0) break;
              cursor = projConvoData.cursor;
              await new Promise(function(r) { setTimeout(r, 500); });
            }
            log("Project " + projName + ": " + projConvoCount + " new, " + projTaggedCount + " tagged");
          }
          log("Total with projects: " + scannedConvos.length);
        } else {
          log("No projects found");
        }
      } catch (projErr) {
        log("Projects check failed: " + projErr.message + " (continuing without)");
      }

      // Show filter panel
      setButtonState(btn, "done", scannedConvos.length + " conversations found");

      // Clean up scan hero display
      var scanHeroEl = document.getElementById("g2c-scan-hero");
      if (scanHeroEl) scanHeroEl.parentNode.removeChild(scanHeroEl);
      var fillEl = document.getElementById("g2c-progress-fill");
      fillEl.classList.remove("indeterminate");
      fillEl.style.width = "0%";
      document.getElementById("g2c-progress").style.display = "none";

      showFilterPanel();

    } catch (err) {
      log("Scan failed: " + err.message, "error");
      setButtonState(btn, "error", err.message);
    }
  }

  // ========== FILTER PANEL (State 3) ==========
  function showFilterPanel() {
    var models = {};
    var oldest = Infinity;
    var newest = 0;
    var sources = {}; // Track main vs project conversations
    for (var i = 0; i < scannedConvos.length; i++) {
      var c = scannedConvos[i];
      var m = getConvoModel(c);
      models[m] = (models[m] || 0) + 1;
      var t = getConvoTime(c);
      if (t > 0 && t < oldest) oldest = t;
      if (t > 0 && t > newest) newest = t;
      // Track source
      var src = c._project || "Main conversations";
      sources[src] = (sources[src] || 0) + 1;
    }
    var modelKeys = Object.keys(models).sort(function(a, b) { return models[b] - models[a]; });

    function tsToDate(ts) {
      if (!ts || ts === Infinity) return "";
      if (typeof ts === "string") {
        // ISO string — just extract the date part
        var d = new Date(ts);
        if (isNaN(d.getTime())) return "";
        return d.toISOString().slice(0, 10);
      }
      var d = new Date(ts > 1e12 ? ts : ts * 1000);
      if (isNaN(d.getTime())) return "";
      return d.toISOString().slice(0, 10);
    }

    var modelCheckboxes = "";
    for (var i = 0; i < modelKeys.length; i++) {
      var mk = modelKeys[i];
      modelCheckboxes += '<label class="g2c-model-row"><input type="checkbox" checked data-model="' + mk + '"> ' + mk + '<span class="cnt">' + models[mk] + '</span></label>';
    }

    // Build source/project checkboxes
    var sourceKeys = Object.keys(sources).sort(function(a, b) {
      if (a === "Main conversations") return -1;
      if (b === "Main conversations") return 1;
      return sources[b] - sources[a];
    });
    var sourceCheckboxes = "";
    var hasProjects = sourceKeys.length > 1;
    for (var si = 0; si < sourceKeys.length; si++) {
      var sk = sourceKeys[si];
      var icon = sk === "Main conversations" ? "\uD83D\uDCAC" : "\uD83D\uDCC1";
      sourceCheckboxes += '<label class="g2c-model-row"><input type="checkbox" checked data-source="' + sk + '"> ' + icon + ' ' + sk + '<span class="cnt">' + sources[sk] + '</span></label>';
    }

    // Scan summary — show project breakdown if applicable
    var projCount = sourceKeys.length - 1;
    var projConvoCount = scannedConvos.filter(function(c) { return c._project; }).length;
    var mainCount = scannedConvos.length - projConvoCount;
    var scanSummaryText = scannedConvos.length.toLocaleString() + '</span>' +
      '<span style="font-size:12px;color:#888;"> conversations scanned</span>';
    if (projCount > 0) {
      scanSummaryText += '<div style="font-size:11px;color:#7eb8a0;margin-top:4px;">' +
        mainCount.toLocaleString() + ' main + ' + projConvoCount + ' from ' + projCount + ' project' + (projCount > 1 ? 's' : '') + '</div>';
    }
    var scanSummary = '<div style="text-align:center;margin-bottom:14px;">' +
      '<span style="font-size:28px;font-weight:800;color:#7eb8a0;">' + scanSummaryText +
      '</div>';

    // Determine if model filter is useful (not just "unknown")
    var hasRealModels = modelKeys.length > 1 || (modelKeys.length === 1 && modelKeys[0] !== "unknown");

    var modelSection = '';
    if (hasRealModels) {
      modelSection = '\
        <div class="g2c-filter-section">\
          <div class="g2c-filter-label">Models</div>\
          <div class="g2c-filter-models" id="g2c-filter-models">' + modelCheckboxes + '</div>\
          <div class="g2c-select-btns"><button id="g2c-sel-all">Select all</button> \u00B7 <button id="g2c-sel-none">Select none</button></div>\
        </div>';
    }

    var filterHtml = '\
      <div class="g2c-filter-panel" id="g2c-filter-panel">\
        ' + scanSummary + '\
        ' + (hasProjects ? '\
        <div class="g2c-filter-section">\
          <div class="g2c-filter-label">Source</div>\
          <div class="g2c-filter-models" id="g2c-filter-sources">' + sourceCheckboxes + '</div>\
        </div>' : '') + '\
        ' + modelSection + '\
        <div class="g2c-filter-section">\
          <div class="g2c-filter-label">Date range</div>\
          <div class="g2c-filter-row">\
            <input type="date" class="g2c-filter-input" id="g2c-date-from" value="' + tsToDate(oldest) + '">\
            <span style="color:#555;">\u2192</span>\
            <input type="date" class="g2c-filter-input" id="g2c-date-to" value="' + tsToDate(newest) + '">\
          </div>\
          <div class="g2c-select-btns" id="g2c-era-btns" style="flex-wrap:wrap;margin-top:4px;">\
            <button data-era="all">All</button> \u00B7\
            <button data-era="gpt35">GPT-3.5</button> \u00B7\
            <button data-era="gpt4">GPT-4</button> \u00B7\
            <button data-era="gpt4o">GPT-4o</button> \u00B7\
            <button data-era="gpt5">GPT-5+</button>\
          </div>\
        </div>\
        <div class="g2c-filter-section">\
          <div class="g2c-filter-label">Max conversations (0 = all)</div>\
          <input type="number" class="g2c-filter-input" id="g2c-limit" value="0" min="0" style="width:100%;">\
        </div>\
        <div class="g2c-filter-section">\
          <div class="g2c-filter-label">Incremental export (skip already exported)</div>\
          <div class="g2c-filter-drop" id="g2c-prev-drop">Drop or click to load previous export</div>\
          <input type="file" id="g2c-prev-file" accept=".json" style="display:none;">\
        </div>\
        <div class="g2c-filter-summary" id="g2c-filter-summary">' + scannedConvos.length + ' conversations selected</div>\
        <button class="g2c-btn" id="g2c-btn-download" style="border-color:#d4a574;margin-bottom:0;">\
          <div class="g2c-btn-icon">\uD83D\uDCE5</div>\
          <div class="g2c-btn-text"><span style="color:#d4a574;">Download ' + scannedConvos.length + ' conversations</span>\
            <div class="g2c-btn-sub">~' + estimateTime(scannedConvos.length) + '</div>\
          </div>\
        </button>\
      </div>';

    // Insert filter panel — with fallback for SPA DOM issues
    var bodyEl = panel.querySelector(".g2c-body");
    if (!bodyEl) {
      log("Warning: panel body not found", "error");
      return;
    }
    var progressEl = document.getElementById("g2c-progress");
    var filterDiv = document.createElement("div");
    filterDiv.innerHTML = filterHtml;
    var filterPanel = filterDiv.firstElementChild || filterDiv.firstChild;
    if (progressEl && progressEl.parentNode) {
      progressEl.parentNode.insertBefore(filterPanel, progressEl);
    } else {
      bodyEl.appendChild(filterPanel);
    }

    // Hide the main buttons — with null guards
    var hideIds = ["g2c-btn-memory", "g2c-btn-convos", "g2c-btn-instructions", "g2c-btn-all"];
    for (var hi = 0; hi < hideIds.length; hi++) {
      var hideEl = document.getElementById(hideIds[hi]);
      if (hideEl) hideEl.style.display = "none";
    }

    // Wire up events using safeAddEvent (BUG FIX)
    if (hasRealModels) {
      safeAddEvent("g2c-sel-all", "click", function() {
        var boxes = document.querySelectorAll("#g2c-filter-models input");
        for (var i = 0; i < boxes.length; i++) boxes[i].checked = true;
        updateFilterSummary();
      });
      safeAddEvent("g2c-sel-none", "click", function() {
        var boxes = document.querySelectorAll("#g2c-filter-models input");
        for (var i = 0; i < boxes.length; i++) boxes[i].checked = false;
        updateFilterSummary();
      });
    }

    safeAddEvent("g2c-prev-drop", "click", function() {
      var fileInput = document.getElementById("g2c-prev-file");
      if (fileInput) fileInput.click();
    });

    var filterInputs = document.querySelectorAll("#g2c-filter-models input, #g2c-filter-sources input, #g2c-date-from, #g2c-date-to, #g2c-limit");
    for (var fi = 0; fi < filterInputs.length; fi++) {
      filterInputs[fi].addEventListener("change", updateFilterSummary);
    }

    // Era preset buttons
    var eraRanges = {
      "all": [tsToDate(oldest), tsToDate(newest)],
      "gpt35": ["2022-11-30", "2023-03-13"],
      "gpt4": ["2023-03-14", "2024-05-12"],
      "gpt4o": ["2024-05-13", "2025-08-06"],
      "gpt5": ["2025-08-07", tsToDate(newest)]
    };
    var eraBtns = document.querySelectorAll("#g2c-era-btns button");
    for (var ei = 0; ei < eraBtns.length; ei++) {
      eraBtns[ei].addEventListener("click", function() {
        var era = this.getAttribute("data-era");
        var range = eraRanges[era];
        if (range) {
          var fromEl = document.getElementById("g2c-date-from");
          var toEl = document.getElementById("g2c-date-to");
          if (fromEl) fromEl.value = range[0];
          if (toEl) toEl.value = range[1];
          // Highlight active era button
          var siblings = document.querySelectorAll("#g2c-era-btns button");
          for (var si = 0; si < siblings.length; si++) siblings[si].style.color = "";
          this.style.color = "#d4a574";
          updateFilterSummary();
        }
      });
    }

    safeAddEvent("g2c-prev-file", "change", function() {
      if (this.files.length) loadPreviousExport(this.files[0]);
    });
    var dropEl = document.getElementById("g2c-prev-drop");
    if (dropEl) {
      dropEl.addEventListener("dragover", function(e) { e.preventDefault(); this.style.borderColor = "#d4a574"; });
      dropEl.addEventListener("dragleave", function() { this.style.borderColor = ""; });
      dropEl.addEventListener("drop", function(e) {
        e.preventDefault();
        this.style.borderColor = "";
        if (e.dataTransfer.files.length) loadPreviousExport(e.dataTransfer.files[0]);
      });
    }

    safeAddEvent("g2c-btn-download", "click", startFilteredDownload);

    // Ensure all model and source checkboxes are programmatically checked (defensive)
    var allBoxes = document.querySelectorAll("#g2c-filter-models input, #g2c-filter-sources input");
    for (var bi = 0; bi < allBoxes.length; bi++) allBoxes[bi].checked = true;

    // Force-recalculate summary after DOM is fully wired
    updateFilterSummary();
  }

  function estimateTime(count) {
    // Real-world calibration: 3361 convos = 29m34s = ~5.3s per batch of 10
    // Using 5s per batch as conservative estimate
    var secs = Math.ceil(count / BATCH_SIZE) * 5;
    if (secs < 60) return "~" + Math.max(Math.round(secs), 1) + " seconds";
    var mins = Math.round(secs / 60);
    if (mins < 60) return "~" + mins + " minutes";
    var hrs = (secs / 3600).toFixed(1);
    return "~" + hrs + " hours";
  }

  function getFilteredConvos() {
    try {
      var selectedModels = {};
      var boxes = document.querySelectorAll("#g2c-filter-models input");
      for (var i = 0; i < boxes.length; i++) {
        if (boxes[i].checked) selectedModels[boxes[i].getAttribute("data-model")] = true;
      }

      // Source/project filter
      var selectedSources = {};
      var sourceBoxes = document.querySelectorAll("#g2c-filter-sources input");
      for (var si = 0; si < sourceBoxes.length; si++) {
        if (sourceBoxes[si].checked) selectedSources[sourceBoxes[si].getAttribute("data-source")] = true;
      }
      var hasSourceFilter = sourceBoxes.length > 0 && Object.keys(selectedSources).length > 0;

      // If no models selected, return all (fail-open)
      var hasModelFilter = Object.keys(selectedModels).length > 0;

      var fromEl = document.getElementById("g2c-date-from");
      var toEl = document.getElementById("g2c-date-to");
      var limitEl = document.getElementById("g2c-limit");

      var fromStr = fromEl ? fromEl.value : "";
      var toStr = toEl ? toEl.value : "";
      var fromTs = fromStr ? new Date(fromStr + "T00:00:00").getTime() / 1000 : 0;
      var toTs = toStr ? new Date(toStr + "T23:59:59").getTime() / 1000 : Infinity;

      var limit = limitEl ? (parseInt(limitEl.value) || 0) : 0;

      var filtered = [];
      var mainCount = 0;
      for (var i = 0; i < scannedConvos.length; i++) {
        var c = scannedConvos[i];

        // Source filter
        if (hasSourceFilter) {
          var src = c._project || "Main conversations";
          if (!selectedSources[src]) continue;
        }

        var model = getConvoModel(c);
        if (hasModelFilter && !selectedModels[model]) continue;

        var ts = getConvoTime(c);
        if (ts > 0 && (ts < fromTs || ts > toTs)) continue;

        if (previousExportIds[c.id]) continue;

        // Limit only applies to main conversations — project convos always included
        if (!c._project) {
          if (limit > 0 && mainCount >= limit) continue;
          mainCount++;
        }

        filtered.push(c);
      }
      return filtered;
    } catch (err) {
      log("Filter error: " + err.message, "error");
      return scannedConvos; // fail-open: return all
    }
  }

  function updateFilterSummary() {
    var filtered = getFilteredConvos();
    var summary = document.getElementById("g2c-filter-summary");
    var dlBtn = document.getElementById("g2c-btn-download");
    var skipped = Object.keys(previousExportIds).length;
    var text = filtered.length + " conversations selected";
    if (skipped > 0) text += " (" + skipped + " skipped from previous export)";
    if (summary) summary.textContent = text;
    if (dlBtn) {
      var spanEl = dlBtn.querySelector(".g2c-btn-text span");
      if (spanEl) spanEl.textContent = "Download " + filtered.length + " conversations";
      var subEl = dlBtn.querySelector(".g2c-btn-sub");
      if (subEl) subEl.textContent = estimateTime(filtered.length);
    }
  }

  function loadPreviousExport(file) {
    var dropEl = document.getElementById("g2c-prev-drop");
    if (dropEl) dropEl.textContent = "Loading " + file.name + "...";
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        var convos = data.conversations || data || [];
        if (Array.isArray(convos)) {
          previousExportIds = {};
          for (var i = 0; i < convos.length; i++) {
            if (convos[i].id) previousExportIds[convos[i].id] = true;
          }
          if (dropEl) {
            dropEl.textContent = "\u2705 " + Object.keys(previousExportIds).length + " conversations from previous export";
            dropEl.className = "g2c-filter-drop active";
          }
          log("Loaded previous export: " + Object.keys(previousExportIds).length + " conversation IDs");
          updateFilterSummary();
        }
      } catch (err) {
        if (dropEl) dropEl.textContent = "\u274C Could not parse file";
        log("Previous export error: " + err.message, "error");
      }
    };
    reader.readAsText(file);
  }

  // ========== CONVERSATION PROCESSING HELPERS ==========
  function extractNodeText(node) {
    if (!node || !node.message || !node.message.content) return "";
    var content = node.message.content;

    // Handle special content types at the top level
    var ct = content.content_type;
    if (ct === "model_editable_context") return ""; // system memory, skip
    if (ct === "thoughts") {
      // Reasoning model thinking block — OpenAI hides actual CoT
      return "[thinking]";
    }
    if (ct === "reasoning_recap") {
      // "Thought for a few seconds" etc
      return "[" + (content.content || "Thinking...") + "]";
    }
    if (ct === "code" || ct === "execution_output") {
      var lang = content.language || "";
      var codeText = content.text || "";
      if (lang === "unknown" && codeText.indexOf("search(") === 0) {
        return "[\uD83D\uDD0D " + codeText + "]";
      }
      return "```" + lang + "\n" + codeText + "\n```";
    }

    var parts = content.parts;
    if (!Array.isArray(parts)) return JSON.stringify(content);
    var textParts = [];
    for (var p = 0; p < parts.length; p++) {
      if (typeof parts[p] === "string") {
        textParts.push(parts[p]);
      } else if (parts[p] && typeof parts[p] === "object") {
        if (parts[p].content_type === "image_asset_pointer" || parts[p].asset_pointer) {
          var imgName = (parts[p].metadata && parts[p].metadata.dalle && parts[p].metadata.dalle.prompt)
            ? "DALL-E: " + parts[p].metadata.dalle.prompt : "image";
          textParts.push("[\uD83D\uDDBC " + imgName + "]");
        }
      }
    }
    return textParts.join("\n")
      .replace(/\uE200cite(\uE202turn\dsearch\d+)+\uE201/g, "")
      .replace(/\uE200image_group\uE202\{[^}]*\}\uE201/g, "[🖼 images]")
      .replace(/\uE200[\s\S]*?\uE201/g, "");
  }

  function extractNodeRole(node) {
    return (node.message && node.message.author && node.message.author.role) || "unknown";
  }

  function extractNodeModel(node) {
    return (node.message && node.message.metadata && node.message.metadata.model_slug) || null;
  }

  function extractNodeTime(node) {
    return (node.message && node.message.create_time) || null;
  }

  function processConversationDetail(detail, listItem) {
    var messages = [];
    var hasBranches = false;

    if (detail.mapping) {
      var mapKeys = Object.keys(detail.mapping);
      var rootId = null;
      for (var mk = 0; mk < mapKeys.length; mk++) {
        if (!detail.mapping[mapKeys[mk]].parent) {
          rootId = mapKeys[mk];
          break;
        }
      }
      if (!rootId) rootId = mapKeys[0];

      var current = rootId;
      var visited = {};
      var safety = 0;

      while (current && safety < 50000) {
        safety++;
        if (visited[current]) break;
        visited[current] = true;
        var node = detail.mapping[current];
        if (!node) break;

        if (node.message && node.message.content) {
          var text = extractNodeText(node);
          if (text.trim() !== "") {
            var msgObj = {
              role: extractNodeRole(node),
              content: text,
              timestamp: extractNodeTime(node),
              model: extractNodeModel(node)
            };

            if (node.parent && detail.mapping[node.parent]) {
              var parentNode = detail.mapping[node.parent];
              if (parentNode.children && parentNode.children.length > 1) {
                var alts = [];
                for (var ci = 0; ci < parentNode.children.length; ci++) {
                  var sibId = parentNode.children[ci];
                  if (sibId === current) continue;
                  var sib = detail.mapping[sibId];
                  if (sib && sib.message && sib.message.content) {
                    var sibText = extractNodeText(sib);
                    if (sibText.trim()) {
                      alts.push({
                        content: sibText,
                        role: extractNodeRole(sib),
                        timestamp: extractNodeTime(sib),
                        model: extractNodeModel(sib)
                      });
                    }
                  }
                }
                if (alts.length > 0) {
                  msgObj.alternatives = alts;
                  hasBranches = true;
                }
              }
            }

            messages.push(msgObj);
          }
        }

        if (node.children && node.children.length > 0) {
          current = node.children[node.children.length - 1];
        } else {
          break;
        }
      }
    }

    // Extract model from mapping metadata (since list API no longer provides it)
    var model = detail.default_model_slug || null;
    if (!model && detail.mapping) {
      var mKeys = Object.keys(detail.mapping);
      for (var mi = 0; mi < mKeys.length; mi++) {
        var mNode = detail.mapping[mKeys[mi]];
        if (mNode && mNode.message && mNode.message.metadata && mNode.message.metadata.model_slug) {
          model = mNode.message.metadata.model_slug;
          break;
        }
      }
    }

    return {
      id: detail.conversation_id || (listItem && listItem.id) || detail.id,
      title: detail.title || (listItem && listItem.title) || "Untitled",
      create_time: detail.create_time || (listItem && listItem.create_time) || null,
      update_time: detail.update_time || (listItem && listItem.update_time) || null,
      model: model,
      project: (listItem && listItem._project) || null,
      project_id: (listItem && listItem._project_id) || null,
      has_branches: hasBranches,
      message_count: messages.length,
      messages: messages
    };
  }

  // ========== FILTERED DOWNLOAD (States 4 & 5) ==========

  function updateDlUI(completed, total, title, startTime) {
    var pct = Math.round((completed / total) * 100);
    var remaining = total - completed;

    var dlCount = document.getElementById("g2c-dl-count");
    var dlTitle = document.getElementById("g2c-dl-title");
    var dlFill = document.getElementById("g2c-dl-fill");
    var dlPct = document.getElementById("g2c-dl-pct");
    var dlRemaining = document.getElementById("g2c-dl-remaining");
    var dlMode = document.getElementById("g2c-dl-mode");

    if (dlCount) dlCount.textContent = completed;
    if (dlTitle) dlTitle.textContent = title;
    if (dlFill) dlFill.style.width = pct + "%";
    if (dlPct) dlPct.textContent = pct + "%";

    if (dlRemaining && completed > 0) {
      var elapsed = (Date.now() - startTime) / 1000;
      var perItem = elapsed / completed;
      var secsLeft = Math.round(perItem * remaining);
      if (secsLeft < 60) {
        dlRemaining.textContent = "~" + secsLeft + " seconds remaining";
      } else {
        dlRemaining.textContent = "~" + Math.round(secsLeft / 60) + " minutes remaining";
      }
    }
  }

  async function downloadBatch(ids, token) {
    var resp = await fetch("https://chatgpt.com/backend-api/conversations/batch", {
      method: "POST",
      credentials: "include",
      headers: {"Authorization": "Bearer " + token, "Content-Type": "application/json"},
      body: JSON.stringify({conversation_ids: ids})
    });
    return resp;
  }

  async function downloadSingle(id, token) {
    var resp = await fetch("https://chatgpt.com/backend-api/conversation/" + id, {
      credentials: "include",
      headers: {"Authorization": "Bearer " + token}
    });
    return resp;
  }

  async function startFilteredDownload() {
    var filtered = getFilteredConvos();
    if (filtered.length === 0) {
      alert("No conversations selected. Adjust your filters.");
      return;
    }

    // Replace filter panel with download hero UI (State 4)
    var filterPanel = document.getElementById("g2c-filter-panel");
    if (filterPanel) {
      filterPanel.innerHTML = '\
        <div class="g2c-dl-hero" id="g2c-dl-hero">\
          <span class="g2c-dl-count" id="g2c-dl-count">0</span>\
          <span class="g2c-dl-of" id="g2c-dl-of"> / ' + filtered.length + '</span>\
          <div class="g2c-dl-title" id="g2c-dl-title">Starting download\u2026</div>\
        </div>\
        <div style="margin:10px 0;">\
          <div class="g2c-progress-bar"><div class="g2c-progress-fill" id="g2c-dl-fill" style="width:0%;"></div></div>\
          <div class="g2c-dl-pct" id="g2c-dl-pct">0%</div>\
        </div>\
        <div class="g2c-dl-remaining" id="g2c-dl-remaining"></div>\
        <div class="g2c-dl-mode" id="g2c-dl-mode" style="text-align:center;font-size:10px;color:#666;margin-top:4px;"></div>';
    }

    var startTime = Date.now();

    try {
      var token = await getToken();

      var fullExport = {
        export_date: new Date().toISOString(),
        tool: "GPT2Claude Migration Kit v2.3",
        format_version: 3,
        total_conversations: filtered.length,
        conversations: []
      };

      var successCount = 0;
      var errorCount = 0;
      var useBatch = true;

      // Build ID-to-listItem lookup
      var listLookup = {};
      for (var li = 0; li < filtered.length; li++) {
        listLookup[filtered[li].id] = filtered[li];
      }

      // ---- TRY BATCH MODE FIRST ----
      log("Using batch download (10 at a time)\u2026");
      var dlMode = document.getElementById("g2c-dl-mode");
      if (dlMode) dlMode.textContent = "\u26A1 Batch mode \u2014 10x faster";

      var batchIndex = 0;
      var consecutiveGroupFails = 0;
      var MAX_CONSECUTIVE_FAILS = 3;

      // Helper: download a list of IDs individually, return results
      async function downloadIndividually(items, tkn) {
        var results = [];
        for (var ii = 0; ii < items.length; ii++) {
          try {
            var resp = await downloadSingle(items[ii].id, tkn);
            if (resp.status === 429) {
              log("Rate limited, waiting 30s\u2026", "error");
              await new Promise(function(r) { setTimeout(r, 30000); });
              ii--; continue;
            }
            if (resp.status !== 200) {
              results.push({error: "HTTP " + resp.status, item: items[ii]});
              continue;
            }
            var det = await resp.json();
            results.push({detail: det, item: items[ii]});
          } catch (e) {
            results.push({error: e.message, item: items[ii]});
          }
          await new Promise(function(r) { setTimeout(r, 500); });
        }
        return results;
      }

      // Helper: try a batch, return {ok, data, status}
      async function tryBatch(ids, tkn) {
        try {
          var resp = await downloadBatch(ids, tkn);
          if (resp.status === 200) {
            var d = await resp.json();
            return {ok: true, data: d, status: 200};
          }
          return {ok: false, data: null, status: resp.status};
        } catch (e) {
          return {ok: false, data: null, status: 0, error: e.message};
        }
      }

      while (batchIndex < filtered.length && useBatch) {
        var batchItems = filtered.slice(batchIndex, batchIndex + BATCH_SIZE);
        var batchIds = [];
        for (var bi = 0; bi < batchItems.length; bi++) batchIds.push(batchItems[bi].id);

        // --- Attempt 1: full batch ---
        var result = await tryBatch(batchIds, token);

        if (result.status === 429) {
          log("Rate limited, waiting 30s\u2026", "error");
          var dlTitle = document.getElementById("g2c-dl-title");
          var dlRemaining = document.getElementById("g2c-dl-remaining");
          if (dlTitle) dlTitle.textContent = "Rate limited \u2014 waiting 30s\u2026";
          if (dlRemaining) dlRemaining.textContent = "Will resume automatically";
          await new Promise(function(r) { setTimeout(r, 30000); });
          continue; // retry same batch
        }

        if (result.status === 422 || result.status === 405 || result.status === 404) {
          log("Batch endpoint unavailable (HTTP " + result.status + "), falling back to individual downloads\u2026", "error");
          useBatch = false;
          break;
        }

        if (result.ok) {
          // Success — process batch
          consecutiveGroupFails = 0;
          var batchData = result.data;
          var batchArr = Array.isArray(batchData) ? batchData : Object.values(batchData);

          for (var bj = 0; bj < batchArr.length; bj++) {
            try {
              var detail = batchArr[bj];
              var detailId = detail.conversation_id || detail.id;
              var listItem = listLookup[detailId] || batchItems[bj];
              var processed = processConversationDetail(detail, listItem);
              fullExport.conversations.push(processed);
              successCount++;
            } catch (procErr) {
              var errTitle = (batchItems[bj] && batchItems[bj].title) || "Unknown";
              log("Error processing: " + errTitle + " \u2014 " + procErr.message, "error");
              errorCount++;
              fullExport.conversations.push({
                id: batchIds[bj],
                title: errTitle,
                error: procErr.message
              });
            }
          }

          batchIndex += BATCH_SIZE;
          await new Promise(function(r) { setTimeout(r, 500); });

        } else {
          // --- Batch failed (likely 500) — graduated retry ---
          log("Batch error (HTTP " + (result.status || result.error) + "), retrying in 3s\u2026", "error");
          if (dlMode) dlMode.textContent = "\u26A1 Retrying batch\u2026";
          await new Promise(function(r) { setTimeout(r, 3000); });

          // --- Attempt 2: retry same batch ---
          var retry = await tryBatch(batchIds, token);

          if (retry.ok) {
            consecutiveGroupFails = 0;
            var retryArr = Array.isArray(retry.data) ? retry.data : Object.values(retry.data);
            for (var rj = 0; rj < retryArr.length; rj++) {
              try {
                var det = retryArr[rj];
                var detId = det.conversation_id || det.id;
                var li = listLookup[detId] || batchItems[rj];
                fullExport.conversations.push(processConversationDetail(det, li));
                successCount++;
              } catch (e) {
                errorCount++;
                fullExport.conversations.push({id: batchIds[rj], title: (batchItems[rj] && batchItems[rj].title) || "Unknown", error: e.message});
              }
            }
            batchIndex += BATCH_SIZE;
            await new Promise(function(r) { setTimeout(r, 500); });

          } else if (batchIds.length > 1) {
            // --- Attempt 3: split batch in half ---
            log("Retry failed, splitting batch\u2026", "error");
            if (dlMode) dlMode.textContent = "\u26A1 Splitting batch\u2026";
            var mid = Math.ceil(batchIds.length / 2);
            var halfA = batchIds.slice(0, mid);
            var halfB = batchIds.slice(mid);
            var itemsA = batchItems.slice(0, mid);
            var itemsB = batchItems.slice(mid);

            var anyHalfFailed = false;
            var halves = [{ids: halfA, items: itemsA}, {ids: halfB, items: itemsB}];

            for (var hi = 0; hi < halves.length; hi++) {
              var halfResult = await tryBatch(halves[hi].ids, token);
              if (halfResult.ok) {
                var halfArr = Array.isArray(halfResult.data) ? halfResult.data : Object.values(halfResult.data);
                for (var hj = 0; hj < halfArr.length; hj++) {
                  try {
                    var hDet = halfArr[hj];
                    var hId = hDet.conversation_id || hDet.id;
                    var hLi = listLookup[hId] || halves[hi].items[hj];
                    fullExport.conversations.push(processConversationDetail(hDet, hLi));
                    successCount++;
                  } catch (e) {
                    errorCount++;
                    fullExport.conversations.push({id: halves[hi].ids[hj], title: (halves[hi].items[hj] && halves[hi].items[hj].title) || "Unknown", error: e.message});
                  }
                }
              } else {
                // Half batch also failed — download individually
                anyHalfFailed = true;
                log("Half-batch failed, downloading " + halves[hi].ids.length + " individually\u2026", "error");
                var indResults = await downloadIndividually(halves[hi].items, token);
                for (var ir = 0; ir < indResults.length; ir++) {
                  if (indResults[ir].detail) {
                    try {
                      fullExport.conversations.push(processConversationDetail(indResults[ir].detail, indResults[ir].item));
                      successCount++;
                    } catch (e) {
                      errorCount++;
                      fullExport.conversations.push({id: indResults[ir].item.id, title: indResults[ir].item.title || "Unknown", error: e.message});
                    }
                  } else {
                    errorCount++;
                    fullExport.conversations.push({id: indResults[ir].item.id, title: indResults[ir].item.title || "Unknown", error: indResults[ir].error});
                  }
                }
              }
              await new Promise(function(r) { setTimeout(r, 500); });
            }

            if (anyHalfFailed) {
              consecutiveGroupFails++;
              log("Batch group recovered individually, resuming batch mode (" + consecutiveGroupFails + "/" + MAX_CONSECUTIVE_FAILS + " fails)", "error");
            } else {
              consecutiveGroupFails = 0;
            }

            batchIndex += BATCH_SIZE;

          } else {
            // Single item batch failed — download individually
            var singleResults = await downloadIndividually(batchItems, token);
            for (var sr = 0; sr < singleResults.length; sr++) {
              if (singleResults[sr].detail) {
                try {
                  fullExport.conversations.push(processConversationDetail(singleResults[sr].detail, singleResults[sr].item));
                  successCount++;
                } catch (e) {
                  errorCount++;
                  fullExport.conversations.push({id: singleResults[sr].item.id, title: singleResults[sr].item.title || "Unknown", error: e.message});
                }
              } else {
                errorCount++;
                fullExport.conversations.push({id: singleResults[sr].item.id, title: singleResults[sr].item.title || "Unknown", error: singleResults[sr].error});
              }
            }
            consecutiveGroupFails++;
            batchIndex += BATCH_SIZE;
          }

          // Check if we should permanently give up on batch mode
          if (consecutiveGroupFails >= MAX_CONSECUTIVE_FAILS) {
            log("Too many consecutive batch failures (" + MAX_CONSECUTIVE_FAILS + "), switching to individual mode", "error");
            useBatch = false;
          } else if (consecutiveGroupFails > 0) {
            if (dlMode) dlMode.textContent = "\u26A1 Batch mode \u2014 resumed";
          }
        }

        // Update UI after each group
        var completed = successCount + errorCount;
        var lastTitle = batchItems[batchItems.length - 1].title || "Untitled";
        updateDlUI(completed, filtered.length, lastTitle, startTime);

        if (completed % 100 === 0 || completed === filtered.length) {
          log("Progress: " + completed + "/" + filtered.length);
        }
      }

      // ---- FALLBACK: INDIVIDUAL DOWNLOADS ----
      if (!useBatch) {
        if (dlMode) dlMode.textContent = "\uD83D\uDC22 Individual mode";
        log("Switching to individual downloads\u2026");

        // Start from where batch left off
        var startFrom = successCount + errorCount;
        for (var i = startFrom; i < filtered.length; i++) {
          var c = filtered[i];
          var title = c.title || "Untitled";

          updateDlUI(i + 1, filtered.length, title, startTime);

          try {
            var convoResp = await downloadSingle(c.id, token);

            if (convoResp.status === 429) {
              log("Rate limited, waiting 30s\u2026", "error");
              var dlTitle = document.getElementById("g2c-dl-title");
              var dlRemaining = document.getElementById("g2c-dl-remaining");
              if (dlTitle) dlTitle.textContent = "Rate limited \u2014 waiting 30s\u2026";
              if (dlRemaining) dlRemaining.textContent = "Will resume automatically";
              await new Promise(function(r) { setTimeout(r, 30000); });
              i--;
              continue;
            }

            if (convoResp.status !== 200) {
              log("Skipped: " + title + " (HTTP " + convoResp.status + ")", "error");
              errorCount++;
              fullExport.conversations.push({id: c.id, title: title, error: "HTTP " + convoResp.status});
              continue;
            }

            var detail = await convoResp.json();
            var processed = processConversationDetail(detail, c);
            fullExport.conversations.push(processed);
            successCount++;

            if (i % 25 === 0 && i > 0) {
              log("Progress: " + (i + 1) + "/" + filtered.length);
            }

          } catch (err) {
            log("Error: " + title + " \u2014 " + err.message, "error");
            errorCount++;
            fullExport.conversations.push({id: c.id, title: title, error: err.message});
          }

          await new Promise(function(r) { setTimeout(r, 1000); });
        }
      }

      var json = JSON.stringify(fullExport, null, 2);
      var sizeMB = (json.length / 1024 / 1024).toFixed(1);

      // Smart filename based on what was exported
      var exportFilename = "chatgpt_all_conversations.json";
      var projectNames = {};
      var hasMain = false;
      for (var fi = 0; fi < fullExport.conversations.length; fi++) {
        if (fullExport.conversations[fi].project) {
          projectNames[fullExport.conversations[fi].project] = true;
        } else {
          hasMain = true;
        }
      }
      var projNameList = Object.keys(projectNames);
      if (!hasMain && projNameList.length === 1) {
        // Only one project exported
        exportFilename = "chatgpt_project_" + projNameList[0].toLowerCase().replace(/[^a-z0-9]+/g, "_") + ".json";
      } else if (!hasMain && projNameList.length > 1) {
        exportFilename = "chatgpt_projects.json";
      }
      downloadFile(json, exportFilename, "application/json");
      log("DONE! " + successCount + " conversations, " + errorCount + " errors, ~" + sizeMB + " MB", "success");

      // Collect model breakdown from export
      var modelBreakdown = {};
      for (var mi = 0; mi < fullExport.conversations.length; mi++) {
        var cm = fullExport.conversations[mi].model || "unknown";
        modelBreakdown[cm] = (modelBreakdown[cm] || 0) + 1;
      }
      var sortedModels = Object.keys(modelBreakdown).sort(function(a, b) {
        return modelBreakdown[b] - modelBreakdown[a];
      });

      // Build model tags HTML — top 5 visible, rest collapsed
      var TOP_N = 5;
      var modelTagsHtml = '<div class="g2c-complete-models-wrap">';
      for (var ti = 0; ti < Math.min(TOP_N, sortedModels.length); ti++) {
        var mk = sortedModels[ti];
        modelTagsHtml += '<span class="g2c-scan-tag">' + mk + ' <span style="opacity:0.6;">' + modelBreakdown[mk] + '</span></span>';
      }
      if (sortedModels.length > TOP_N) {
        var moreCount = sortedModels.length - TOP_N;
        modelTagsHtml += '<button class="g2c-models-toggle" id="g2c-models-toggle">+' + moreCount + ' more</button>';
        modelTagsHtml += '<div class="g2c-models-extra" id="g2c-models-extra" style="display:none;">';
        for (var ti = TOP_N; ti < sortedModels.length; ti++) {
          var mk = sortedModels[ti];
          modelTagsHtml += '<span class="g2c-scan-tag">' + mk + ' <span style="opacity:0.6;">' + modelBreakdown[mk] + '</span></span>';
        }
        modelTagsHtml += '</div>';
      }
      modelTagsHtml += '</div>';

      // Show completion screen (State 5)
      var filterPanel = document.getElementById("g2c-filter-panel");
      if (filterPanel) {
        var elapsed = Math.round((Date.now() - startTime) / 1000);
        var elapsedStr = elapsed < 60 ? elapsed + "s" : Math.round(elapsed / 60) + "m " + (elapsed % 60) + "s";

        filterPanel.innerHTML = '\
          <div class="g2c-complete">\
            <div class="g2c-complete-icon">\u2705</div>\
            <div class="g2c-complete-title">Export Complete!</div>\
            <div class="g2c-complete-sub">' + successCount + ' conversations \u00B7 ' + sizeMB + ' MB \u00B7 ' + elapsedStr + '</div>\
            ' + modelTagsHtml + '\
          </div>\
          <div class="g2c-whatsnext">\
            <div class="g2c-whatsnext-title">What\u2019s next?</div>\
            <div class="g2c-whatsnext-item">\
              <span style="color:#a0a0e0;">\uD83D\uDC40 Browse your data</span><br>\
              <span style="color:#999;">Open the <a href="https://siamsnus.github.io/GPT2Claude-Migration-Kit/viewer.html" target="_blank">Conversation Viewer</a> to explore your chats. You can <a href="https://siamsnus.github.io/GPT2Claude-Migration-Kit/viewer.html" download target="_blank">download it</a> for fully offline use.</span>\
            </div>\
            <div class="g2c-whatsnext-item">\
              <span style="color:#7eb8a0;">\uD83D\uDE80 Import to Claude</span> <span class="g2c-whatsnext-badge">recommended</span><br>\
              <span style="color:#999;">Follow the <a href="https://siamsnus.github.io/GPT2Claude-Migration-Kit/#importing" target="_blank">import guide</a> to bring your history into Claude.</span>\
            </div>\
          </div>';

        // Wire up "show more models" toggle
        var modelsToggle = document.getElementById("g2c-models-toggle");
        if (modelsToggle) {
          modelsToggle.addEventListener("click", function() {
            var extra = document.getElementById("g2c-models-extra");
            if (extra) {
              var showing = extra.style.display !== "none";
              extra.style.display = showing ? "none" : "flex";
              this.textContent = showing ? "+" + (sortedModels.length - TOP_N) + " more" : "show less";
            }
          });
        }
      }

    } catch (err) {
      log("Download failed: " + err.message, "error");
      var dlTitle = document.getElementById("g2c-dl-title");
      if (dlTitle) dlTitle.textContent = "Error: " + err.message;
    }
  }

  // ========== EXPORT: INSTRUCTIONS ==========
  async function exportInstructions() {
    var btn = document.getElementById("g2c-btn-instructions");
    setButtonState(btn, "running", "Exporting...");

    try {
      var token = await getToken();
      var headers = {"Authorization": "Bearer " + token};

      var endpoints = [
        {name: "custom_instructions", url: "https://chatgpt.com/backend-api/user_system_messages"},
        {name: "settings", url: "https://chatgpt.com/backend-api/settings"}
      ];

      var result = {
        export_date: new Date().toISOString(),
        tool: "GPT2Claude Migration Kit v2.3",
        data: {}
      };

      for (var i = 0; i < endpoints.length; i++) {
        var ep = endpoints[i];
        log("Fetching " + ep.name + "...");
        try {
          var resp = await fetch(ep.url, {credentials: "include", headers: headers});
          if (resp.status === 200) {
            result.data[ep.name] = await resp.json();
            log("Got: " + ep.name);
          } else if (resp.status === 404) {
            result.data[ep.name] = {note: "Not available on this account"};
            log(ep.name + ": not available (skipped)");
          } else {
            result.data[ep.name] = {error: "HTTP " + resp.status};
            log(ep.name + ": HTTP " + resp.status, "error");
          }
        } catch (e) {
          result.data[ep.name] = {error: e.message};
          log(ep.name + " error: " + e.message, "error");
        }
      }

      downloadFile(JSON.stringify(result, null, 2), "chatgpt_instructions.json", "application/json");
      setButtonState(btn, "done", "Instructions exported");

    } catch (err) {
      log("Instructions export failed: " + err.message, "error");
      setButtonState(btn, "error", err.message);
    }
  }

  // ========== EVENT LISTENERS ==========
  document.getElementById("g2c-close").addEventListener("click", function() {
    panel.style.animation = "g2c-fadein 0.2s ease-out reverse";
    setTimeout(function() { panel.remove(); style.remove(); }, 200);
  });

  document.getElementById("g2c-btn-memory").addEventListener("click", exportMemories);
  document.getElementById("g2c-btn-convos").addEventListener("click", exportConversations);
  document.getElementById("g2c-btn-instructions").addEventListener("click", exportInstructions);

  document.getElementById("g2c-btn-all").addEventListener("click", async function() {
    var btn = document.getElementById("g2c-btn-all");
    setButtonState(btn, "running", "Exporting everything...");
    log("--- EXPORT ALL started ---");
    await exportMemories();
    await exportInstructions();
    log("Memories & instructions done. Scanning conversations...");
    await exportConversations();
    log("Memories & instructions exported. Configure conversation filters and click Download.", "success");
  });

  document.getElementById("g2c-toggle-log").addEventListener("click", function() {
    var logVisible = logEl.classList.contains("visible");
    logEl.classList.toggle("visible");
    this.textContent = logVisible ? "Show log \u25BC" : "Hide log \u25B2";
  });

  // Copy log button
  document.getElementById("g2c-copy-log").addEventListener("click", function() {
    var copyBtn = this;
    var entries = document.querySelectorAll(".g2c-log-entry");
    var text = "";
    for (var i = 0; i < entries.length; i++) {
      text += entries[i].textContent + "\n";
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        copyBtn.textContent = "\u2705 Copied!";
        setTimeout(function() { copyBtn.textContent = "Copy log"; }, 2000);
      }).catch(function() {
        fallbackCopy(text, copyBtn);
      });
    } else {
      fallbackCopy(text, copyBtn);
    }
  });

  function fallbackCopy(text, btn) {
    var ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand("copy");
      btn.textContent = "\u2705 Copied!";
      setTimeout(function() { btn.textContent = "Copy log"; }, 2000);
    } catch (e) {
      btn.textContent = "Copy failed";
      setTimeout(function() { btn.textContent = "Copy log"; }, 2000);
    }
    document.body.removeChild(ta);
  }

  log("Ready. Click a button to start exporting.");
})();

</script>

<script>
// Browser detection
(function() {
  var detect = document.getElementById("browser-detect");
  var isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
  var isChrome = navigator.userAgent.indexOf("Chrome") > -1 && navigator.userAgent.indexOf("Edg") === -1;
  var isEdge = navigator.userAgent.indexOf("Edg") > -1;
  var isBrave = navigator.brave !== undefined;

  if (isFirefox) {
    detect.textContent = "🦊 Firefox detected — use the Firefox tab below";
    showTab("firefox");
  } else if (isBrave) {
    detect.textContent = "🦁 Brave detected — drag the button below";
    showTab("chrome");
  } else if (isEdge) {
    detect.textContent = "🌐 Edge detected — drag the button below";
    showTab("chrome");
  } else if (isChrome) {
    detect.textContent = "✨ Chrome detected — drag the button below";
    showTab("chrome");
  }
})();

// Tab switching
function showTab(name) {
  var tabs = document.querySelectorAll(".tab-content");
  var btns = document.querySelectorAll(".tab-btn");
  for (var i = 0; i < tabs.length; i++) { tabs[i].classList.remove("active"); }
  for (var i = 0; i < btns.length; i++) { btns[i].classList.remove("active"); }
  document.getElementById("tab-" + name).classList.add("active");
  var labels = {"chrome": 0, "firefox": 1, "paste": 2};
  if (labels[name] !== undefined) btns[labels[name]].classList.add("active");
}

// Copy bookmark URL (for Firefox)
var copyUrlBtn = document.getElementById("copy-bookmark-url");
if (copyUrlBtn) {
  copyUrlBtn.addEventListener("click", function() {
    var href = document.getElementById("bookmarklet-btn").getAttribute("href");
    navigator.clipboard.writeText(href).then(function() {
      document.getElementById("copy-url-confirm").style.display = "block";
      copyUrlBtn.innerHTML = "✅ Copied!";
      setTimeout(function() {
        copyUrlBtn.innerHTML = "📋 Copy bookmark URL";
        document.getElementById("copy-url-confirm").style.display = "none";
      }, 4000);
    });
  });
}

// Copy full script (for console paste)
var copyScriptBtn = document.getElementById("copy-full-script");
if (copyScriptBtn) {
  copyScriptBtn.addEventListener("click", function() {
    var code = document.getElementById("migrate-source").textContent.trim();
    navigator.clipboard.writeText(code).then(function() {
      document.getElementById("copy-script-confirm").style.display = "block";
      copyScriptBtn.innerHTML = "✅ Copied!";
      setTimeout(function() {
        copyScriptBtn.innerHTML = "📋 Copy export script";
        document.getElementById("copy-script-confirm").style.display = "none";
      }, 4000);
    });
  });
}
</script>
</body>
</html>